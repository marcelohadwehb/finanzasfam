<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Familiares</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }
        .animate-fade-out-up {
            animation: fadeOutUp 0.5s ease-in forwards;
        }
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

<div id="app" class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-auto overflow-hidden transition-all duration-300">
    <header class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white p-6 rounded-t-2xl">
        <h1 class="text-3xl font-bold text-center">Finanzas Familiares</h1>
        <div class="mt-4 flex justify-between items-center text-sm font-medium">
            <div class="bg-white rounded-full px-3 py-1 flex items-center gap-2">
                <select id="month-select" class="bg-transparent text-gray-800 outline-none cursor-pointer">
                    <!-- Months will be populated by JavaScript -->
                </select>
                <select id="year-select" class="bg-transparent text-gray-800 outline-none cursor-pointer">
                    <!-- Years will be populated by JavaScript -->
                </select>
            </div>
            <div class="flex gap-2">
                <button id="export-excel-btn" class="bg-white hover:bg-gray-200 text-blue-500 font-semibold py-1 px-3 rounded-full shadow-md transition-transform duration-200 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="export-excel-year-btn" class="bg-white hover:bg-gray-200 text-blue-500 font-semibold py-1 px-3 rounded-full shadow-md transition-transform duration-200 transform hover:scale-105">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="p-6">
        <section id="balance-section" class="mb-6 bg-gray-50 rounded-lg p-4 shadow-sm">
            <h2 class="text-lg font-semibold text-center mb-2">Balance Mensual</h2>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-gray-500 text-sm">Ingresos</p>
                    <p id="total-income" class="text-green-600 font-bold text-lg">$0</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Gastos</p>
                    <p id="total-expenses" class="text-red-600 font-bold text-lg">$0</p>
                </div>
                <div>
                    <p id="balance-label" class="text-gray-500 text-sm">Balance</p>
                    <p id="balance" class="font-bold text-lg">$0</p>
                </div>
            </div>
        </section>

        <section id="actions-section" class="grid grid-cols-2 gap-4 mb-6">
            <button id="add-income-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transition-transform duration-200 transform hover:scale-105">
                Ingreso
            </button>
            <button id="add-expense-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transition-transform duration-200 transform hover:scale-105">
                Gasto
            </button>
            <button id="manage-budgets-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-full shadow-lg transition-transform duration-200 transform hover:scale-105">
                Presupuestos
            </button>
            <button id="manage-records-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-full shadow-lg transition-transform duration-200 transform hover:scale-105">
                Registros
            </button>
            <button id="manage-categories-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-full shadow-lg transition-transform duration-200 transform hover:scale-105">
                Categorías
            </button>
        </section>

        <section id="transactions-section">
            <h2 class="text-lg font-semibold mb-3">Transacciones</h2>
            <div id="transactions-list" class="space-y-3">
                <!-- Transactions will be rendered here -->
            </div>
        </section>

    </main>
</div>

<!-- Modal de acceso denegado -->
<div id="access-denied-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center">
        <h3 class="text-2xl font-bold mb-4 text-red-600">Acceso Denegado</h3>
        <p class="text-gray-700">No tienes permiso para acceder a esta aplicación. Por favor, asegúrate de tener el enlace correcto.</p>
    </div>
</div>

<!-- Modals -->
<div id="modal-container" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <!-- Modal content will be injected here -->
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firestore log level to debug
    setLogLevel('debug');

    // Firebase Global Variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Use the firebase config provided by the user
    const firebaseConfig = {
      apiKey: "AIzaSyAjV2HebLZMPXF1Fm7m536pLWnm79rGfGY",
      authDomain: "finanzas-familiares-fa7c5.firebaseapp.com",
      projectId: "finanzas-familiares-fa7c5"
    };

    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    let transactionsData = []; // Global variable to store transactions
    let recordsData = []; // Global variable to store records

    const mainApp = document.getElementById('app');
    const accessDeniedModal = document.getElementById('access-denied-modal');

    // Initialize Firebase
    initializeFirebaseApp();

    async function initializeFirebaseApp() {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Sign in anonymously to avoid the custom token mismatch error
        try {
            await signInAnonymously(auth);
            console.log("Signed in anonymously. User ID:", auth.currentUser.uid);
        } catch (error) {
            console.error("Error signing in anonymously. Access denied:", error);
            showAccessDenied();
            return;
        }

        // This listener ensures we only proceed once we know the auth state.
        onAuthStateChanged(auth, (user) => {
            if (user && !isAuthReady) {
                // Only proceed if the user is authenticated and the app is not yet initialized
                userId = user.uid;
                isAuthReady = true;
                initializeAppLogic();
            }
        });
    }

    function showAccessDenied() {
        mainApp.classList.add('hidden');
        accessDeniedModal.classList.remove('hidden');
    }

    const modalContainer = document.getElementById('modal-container');
    const transactionsList = document.getElementById('transactions-list');
    const totalIncomeEl = document.getElementById('total-income');
    const totalExpensesEl = document.getElementById('total-expenses');
    const balanceEl = document.getElementById('balance');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');

    let currentMonth, currentYear;
    let categories = {};
    let budgets = {};
    let unsubscribeTransactions = null;
    let unsubscribeCategories = null;
    let unsubscribeBudgets = null;
    let unsubscribeRecords = null;
    
    // Function to update the view based on current month/year
    function updateView() {
        if (!isAuthReady || !userId) return;

        if (unsubscribeTransactions) {
            unsubscribeTransactions();
        }
        
        const transactionsRef = collection(db, "artifacts", appId, "public", "data", "transactions");
        const startOfMonth = new Date(currentYear, currentMonth - 1, 1).getTime();
        const endOfMonth = new Date(currentYear, currentMonth, 0, 23, 59, 59).getTime();

        const q = query(transactionsRef,
            where("timestamp", ">=", startOfMonth),
            where("timestamp", "<=", endOfMonth)
        );

        unsubscribeTransactions = onSnapshot(q, (querySnapshot) => {
            const transactions = [];
            querySnapshot.forEach((doc) => {
                transactions.push({ id: doc.id, ...doc.data() });
            });
            renderTransactions(transactions);
            updateBalance(transactions);
        }, (error) => {
            console.error("Error fetching transactions:", error);
        });
    }

    function setupDateSelectors() {
        const today = new Date();
        currentMonth = today.getMonth() + 1; // getMonth() is 0-indexed
        currentYear = today.getFullYear();

        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1;
            option.textContent = month;
            if (index + 1 === currentMonth) option.selected = true;
            monthSelect.appendChild(option);
        });

        for (let year = 2024; year <= 2060; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) option.selected = true;
            yearSelect.appendChild(option);
        }

        monthSelect.addEventListener('change', (e) => {
            currentMonth = parseInt(e.target.value);
            updateView();
        });
        yearSelect.addEventListener('change', (e) => {
            currentYear = parseInt(e.target.value);
            updateView();
        });
    }

    // New function to show a confirmation modal
    function showConfirmationModal(message, onConfirm) {
        const html = `
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm modal-enter modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center">Confirmar</h3>
                <p class="text-gray-700 text-center mb-6">${message}</p>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-confirm-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors">Cancelar</button>
                    <button type="button" id="confirm-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-600 transition-colors">Confirmar</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = html;
        modalContainer.classList.remove('hidden');
        modalContainer.querySelector('.modal-content').classList.add('modal-enter-active');

        document.getElementById('cancel-confirm-btn').addEventListener('click', closeModal);
        document.getElementById('confirm-btn').addEventListener('click', () => {
            onConfirm();
            closeModal();
        });
    }

    // Function to show a temporary message
    function showTemporaryMessage(message) {
        const messageEl = document.createElement('div');
        messageEl.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-xl animate-fade-in-down z-50';
        messageEl.textContent = message;
        document.body.appendChild(messageEl);
        setTimeout(() => {
            messageEl.classList.add('animate-fade-out-up');
            messageEl.addEventListener('animationend', () => messageEl.remove());
        }, 2000);
    }

    function createTransactionModal(type, transaction = null) {
        const title = transaction ? 'Editar Transacción' : (type === 'income' ? 'Registrar Ingreso' : 'Registrar Gasto');
        const isEditing = !!transaction;
        const html = `
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm modal-enter modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center">${title}</h3>
                <form id="${isEditing ? 'edit-transaction-form' : `${type}-form`}">
                    <div class="mb-4">
                        <label for="date" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" value="${transaction ? transaction.date : ''}" required>
                    </div>
                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <input type="number" id="amount" name="amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" value="${transaction ? transaction.amount : ''}" required min="0">
                    </div>
                    ${type === 'expense' ? `
                    <div class="mb-4">
                        <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select id="category" name="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" required>
                            <!-- Categories will be populated by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="subcategory" class="block text-sm font-medium text-gray-700">Subcategoría</label>
                        <select id="subcategory" name="subcategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" required>
                            <!-- Subcategories will be populated by JS -->
                        </select>
                    </div>
                    ` : `
                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <input type="text" id="description" name="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" value="${transaction ? transaction.description : ''}" required>
                    </div>
                    `}
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" id="close-modal" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors">Cancelar</button>
                        <button type="submit" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors">Guardar</button>
                    </div>
                </form>
            </div>
        `;
        modalContainer.innerHTML = html;
        modalContainer.classList.remove('hidden');
        modalContainer.querySelector('.modal-content').classList.add('modal-enter-active');

        // Populate selects
        if (type === 'expense') {
            const categorySelect = document.getElementById('category');
            const subcategorySelect = document.getElementById('subcategory');
            Object.keys(categories).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (transaction && transaction.category === cat) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
            updateSubcategories(categorySelect.value);

            categorySelect.addEventListener('change', (e) => {
                updateSubcategories(e.target.value);
            });

            function updateSubcategories(category) {
                subcategorySelect.innerHTML = '';
                if (categories[category]) {
                    categories[category].forEach(subcat => {
                        const option = document.createElement('option');
                        option.value = subcat;
                        option.textContent = subcat;
                        if (transaction && transaction.subcategory === subcat) {
                            option.selected = true;
                        }
                        subcategorySelect.appendChild(option);
                    });
                }
            }
        }

        const form = document.getElementById(`${isEditing ? 'edit-transaction-form' : `${type}-form`}`);
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = {
                type: type,
                amount: parseInt(formData.get('amount')),
                date: formData.get('date'),
                timestamp: new Date(formData.get('date') + 'T00:00:00').getTime(),
            };
            if (type === 'expense') {
                data.category = formData.get('category');
                data.subcategory = formData.get('subcategory');
            } else {
                data.description = formData.get('description');
            }

            try {
                if (isAuthReady && userId) {
                    if (isEditing) {
                        await updateDoc(doc(db, "artifacts", appId, "public", "data", "transactions", transaction.id), data);
                    } else {
                        await addDoc(collection(db, "artifacts", appId, "public", "data", "transactions"), data);
                    }
                    closeModal();
                } else {
                    console.error("Firestore is not ready or userId is not available.");
                }
            } catch (error) {
                console.error("Error adding/editing document: ", error);
            }
        });

        document.getElementById('close-modal').addEventListener('click', closeModal);
    }

    function createBudgetsModal() {
        const html = `
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg modal-enter modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center">Gestión de Presupuestos</h3>
                <div id="budgets-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <!-- Budgets will be rendered here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-modal" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors">Cerrar</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = html;
        modalContainer.classList.remove('hidden');
        modalContainer.querySelector('.modal-content').classList.add('modal-enter-active');
        renderBudgets();
        document.getElementById('close-modal').addEventListener('click', closeModal);
    }

    function renderBudgets() {
        const budgetsList = document.getElementById('budgets-list');
        budgetsList.innerHTML = '';

        const expensesBySubcategory = transactionsData.filter(t => t.type === 'expense').reduce((acc, t) => {
            if (acc[t.subcategory]) {
                acc[t.subcategory] += t.amount;
            } else {
                acc[t.subcategory] = t.amount;
            }
            return acc;
        }, {});

        Object.keys(categories).forEach(cat => {
            const categoryBudgetTotal = categories[cat].reduce((sum, subcat) => sum + (budgets[subcat] || 0), 0);
            const categorySpentTotal = categories[cat].reduce((sum, subcat) => sum + (expensesBySubcategory[subcat] || 0), 0);
            const differential = categoryBudgetTotal - categorySpentTotal;
            let differentialColor = 'text-gray-600';
            if (differential > 0) {
                differentialColor = 'text-green-600';
            } else if (differential < 0) {
                differentialColor = 'text-red-600';
            }

            const categoryEl = document.createElement('div');
            categoryEl.className = 'p-3 bg-gray-100 rounded-lg shadow-sm';
            categoryEl.innerHTML = `
                <div class="mb-2">
                    <h4 class="font-bold text-lg text-gray-800 flex justify-between items-center">
                        <span>${cat}</span>
                        <span class="text-sm font-normal text-gray-500">Total: $${categoryBudgetTotal.toLocaleString('es-CL')}</span>
                    </h4>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-gray-500">Presupuesto: <span class="text-gray-800 font-medium">$${categoryBudgetTotal.toLocaleString('es-CL')}</span></span>
                        <span class="text-gray-500">Gastado: <span class="text-gray-800 font-medium">$${categorySpentTotal.toLocaleString('es-CL')}</span></span>
                        <span class="text-gray-500">Diferencial: <span class="${differentialColor} font-medium">$${differential.toLocaleString('es-CL')}</span></span>
                    </div>
                </div>
                <div class="mt-2 space-y-2">
                    ${categories[cat].map(subcat => `
                        <div class="flex items-center justify-between gap-2">
                            <span class="text-sm text-gray-600 w-1/2">${subcat}</span>
                            <input type="number" data-subcategory="${subcat}" value="${budgets[subcat] || 0}" class="flex-grow rounded-md border-gray-300 shadow-sm focus:ring-blue-500 text-right pr-2">
                        </div>
                    `).join('')}
                </div>
            `;
            budgetsList.appendChild(categoryEl);
        });

        budgetsList.querySelectorAll('input').forEach(input => {
            input.addEventListener('blur', async (e) => {
                const subcategory = e.target.dataset.subcategory;
                const newBudget = parseInt(e.target.value);
                if (isAuthReady && userId) {
                    try {
                        const budgetsRef = doc(db, "artifacts", appId, "public", "data", "budgets", "budgets");
                        await setDoc(budgetsRef, { [subcategory]: newBudget }, { merge: true });
                        showTemporaryMessage('¡Guardado!');
                    } catch (error) {
                        console.error("Error updating budget:", error);
                    }
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur(); // Trigger blur to save the value
                }
            });
        });
    }

    function createRecordsModal() {
        const html = `
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl modal-enter modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center">Gestión de Registros</h3>
                <div class="flex mb-4">
                    <input type="text" id="new-record-name" class="flex-grow rounded-md border-gray-300 shadow-sm focus:ring-blue-500" placeholder="Nombre del nuevo registro">
                    <button id="add-record-btn" class="ml-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors">Agregar</button>
                </div>
                <div id="records-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <!-- Records will be rendered here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-modal" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors">Cerrar</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = html;
        modalContainer.classList.remove('hidden');
        modalContainer.querySelector('.modal-content').classList.add('modal-enter-active');
        renderRecords();

        document.getElementById('add-record-btn').addEventListener('click', async () => {
            const newRecordName = document.getElementById('new-record-name').value.trim();
            if (newRecordName) {
                try {
                    await addDoc(collection(db, "artifacts", appId, "public", "data", "records"), {
                        name: newRecordName,
                        entries: '[]' // Store as JSON string
                    });
                    document.getElementById('new-record-name').value = '';
                } catch (error) {
                    console.error("Error adding new record:", error);
                }
            }
        });

        document.getElementById('close-modal').addEventListener('click', closeModal);
    }

    function renderRecords() {
        const recordsList = document.getElementById('records-list');
        recordsList.innerHTML = '';
        recordsData.forEach(record => {
            const entries = JSON.parse(record.entries);
            const total = entries.reduce((sum, entry) => sum + entry.amount, 0);

            const recordEl = document.createElement('div');
            recordEl.className = 'p-4 bg-gray-100 rounded-lg shadow-sm';
            recordEl.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-bold text-lg text-gray-800 flex-grow cursor-pointer" data-id="${record.id}">${record.name}</h4>
                    <span class="font-bold text-gray-800 text-lg flex-shrink-0 ml-4">$${total.toLocaleString('es-CL')}</span>
                    <button class="ml-2 text-red-500 hover:text-red-700" data-delete-id="${record.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="bg-white p-3 rounded-lg mt-2 hidden" data-content-id="${record.id}">
                    <div class="space-y-2" data-entries-list="${record.id}">
                        <!-- Entries will be rendered here -->
                    </div>
                    <div class="flex items-center gap-2 mt-3">
                        <input type="text" class="flex-grow rounded-md border-gray-300 shadow-sm" placeholder="Nueva descripción" data-desc-input="${record.id}">
                        <input type="number" class="w-24 rounded-md border-gray-300 shadow-sm" placeholder="Monto" data-amount-input="${record.id}" min="0">
                        <button class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full hover:bg-blue-600 transition-colors" data-add-entry-id="${record.id}">Agregar</button>
                    </div>
                </div>
            `;
            recordsList.appendChild(recordEl);

            const entriesList = recordEl.querySelector(`[data-entries-list="${record.id}"]`);
            entries.forEach((entry, index) => {
                const entryEl = document.createElement('div');
                entryEl.className = 'flex items-center justify-between text-sm text-gray-600';
                entryEl.innerHTML = `
                    <span class="flex-grow">${entry.description}</span>
                    <span class="font-semibold text-gray-800">$${entry.amount.toLocaleString('es-CL')}</span>
                    <button class="ml-2 text-red-500 hover:text-red-700" data-delete-entry-id="${record.id}" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                entriesList.appendChild(entryEl);
            });
        });

        // Add event listeners for records
        recordsList.querySelectorAll('h4').forEach(h4 => {
            h4.addEventListener('click', () => {
                const content = recordsList.querySelector(`[data-content-id="${h4.dataset.id}"]`);
                content.classList.toggle('hidden');
            });
        });

        recordsList.querySelectorAll('[data-delete-id]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const recordId = e.target.closest('button').dataset.deleteId;
                showConfirmationModal('¿Estás seguro de que quieres eliminar este registro?', async () => {
                    try {
                        await deleteDoc(doc(db, "artifacts", appId, "public", "data", "records", recordId));
                    } catch (error) {
                        console.error("Error deleting record:", error);
                    }
                });
            });
        });

        recordsList.querySelectorAll('[data-add-entry-id]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const recordId = e.target.dataset.addEntryId;
                const descInput = recordsList.querySelector(`[data-desc-input="${recordId}"]`);
                const amountInput = recordsList.querySelector(`[data-amount-input="${recordId}"]`);
                const description = descInput.value.trim();
                const amount = parseInt(amountInput.value);

                if (description && amount > 0) {
                    const record = recordsData.find(r => r.id === recordId);
                    if (record) {
                        const entries = JSON.parse(record.entries);
                        entries.push({ description, amount });
                        try {
                            await updateDoc(doc(db, "artifacts", appId, "public", "data", "records", recordId), {
                                entries: JSON.stringify(entries)
                            });
                            descInput.value = '';
                            amountInput.value = '';
                        } catch (error) {
                            console.error("Error adding entry:", error);
                        }
                    }
                }
            });
        });

        recordsList.querySelectorAll('[data-delete-entry-id]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const recordId = e.target.closest('button').dataset.deleteEntryId;
                const entryIndex = parseInt(e.target.closest('button').dataset.index);
                showConfirmationModal('¿Estás seguro de que quieres eliminar esta descripción?', async () => {
                    const record = recordsData.find(r => r.id === recordId);
                    if (record) {
                        const entries = JSON.parse(record.entries);
                        entries.splice(entryIndex, 1);
                        try {
                            await updateDoc(doc(db, "artifacts", appId, "public", "data", "records", recordId), {
                                entries: JSON.stringify(entries)
                            });
                        } catch (error) {
                            console.error("Error deleting entry:", error);
                        }
                    }
                });
            });
        });
    }

    function createCategoriesModal() {
        const html = `
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg modal-enter modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center">Gestión de Categorías</h3>
                <div class="mb-4">
                    <label for="new-category" class="block text-sm font-medium text-gray-700">Nueva Categoría</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="new-category" class="flex-grow rounded-md border-gray-300 shadow-sm focus:ring-blue-500" placeholder="Nombre de la nueva categoría">
                        <button type="button" id="add-category-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors">Agregar</button>
                    </div>
                </div>
                <div class="space-y-4 max-h-96 overflow-y-auto pr-2" id="categories-list">
                    <!-- Categories will be rendered here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-modal" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors">Cerrar</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = html;
        modalContainer.classList.remove('hidden');
        modalContainer.querySelector('.modal-content').classList.add('modal-enter-active');
        renderCategories();

        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('add-category-btn').addEventListener('click', async () => {
            const newCatInput = document.getElementById('new-category');
            const newCatName = newCatInput.value.trim();
            if (newCatName && !categories[newCatName]) {
                categories[newCatName] = [];
                await saveCategories();
                newCatInput.value = '';
                renderCategories();
            }
        });
    }

    async function saveCategories() {
        if (isAuthReady && userId) {
            try {
                const categoriesRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
                await setDoc(categoriesRef, categories);
            } catch (error) {
                console.error("Error saving categories:", error);
            }
        }
    }

    function renderCategories() {
        const categoriesList = document.getElementById('categories-list');
        categoriesList.innerHTML = '';
        Object.keys(categories).forEach(cat => {
            const categoryEl = document.createElement('div');
            categoryEl.className = 'p-3 bg-gray-100 rounded-lg shadow-sm';
            categoryEl.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <input type="text" value="${cat}" class="bg-transparent font-bold text-gray-800 flex-grow" data-category="${cat}">
                    <div class="flex gap-2">
                        <button data-action="delete-cat" data-category="${cat}" class="text-red-500 hover:text-red-700">Eliminar</button>
                    </div>
                </div>
                <div class="mt-2 space-y-2 border-t pt-2">
                    ${categories[cat].map(subcat => `
                        <div class="flex items-center justify-between gap-2 text-sm text-gray-600">
                            <input type="text" value="${subcat}" class="bg-transparent flex-grow" data-category="${cat}" data-subcategory="${subcat}">
                            <button data-action="delete-subcat" data-category="${cat}" data-subcategory="${subcat}" class="text-red-500 hover:text-red-700">Eliminar</button>
                        </div>
                    `).join('')}
                    <div class="flex items-center gap-2 mt-2">
                        <input type="text" class="flex-grow rounded-md border-gray-300 shadow-sm" placeholder="Nueva subcategoría" data-add-subcat-input="${cat}">
                        <button data-action="add-subcat" data-category="${cat}" class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full hover:bg-blue-600 transition-colors">Agregar</button>
                    </div>
                </div>
            `;
            categoriesList.appendChild(categoryEl);
        });

        // Event listeners for categories and subcategories
        categoriesList.querySelectorAll('input[data-category]').forEach(input => {
            input.addEventListener('change', async (e) => {
                const oldName = e.target.dataset.category;
                const newName = e.target.value.trim();
                if (newName && oldName !== newName) {
                    if (categories[oldName]) {
                        const subcats = categories[oldName];
                        delete categories[oldName];
                        categories[newName] = subcats;
                        await saveCategories();
                        renderCategories();
                    }
                }
            });
        });

        categoriesList.querySelectorAll('input[data-subcategory]').forEach(input => {
            input.addEventListener('change', async (e) => {
                const category = e.target.dataset.category;
                const oldName = e.target.dataset.subcategory;
                const newName = e.target.value.trim();
                if (newName && oldName !== newName) {
                    const subcatIndex = categories[category].indexOf(oldName);
                    if (subcatIndex > -1) {
                        categories[category][subcatIndex] = newName;
                        await saveCategories();
                        renderCategories();
                    }
                }
            });
        });

        categoriesList.querySelectorAll('[data-action="delete-cat"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const category = e.target.dataset.category;
                showConfirmationModal(`¿Estás seguro de que quieres eliminar la categoría "${category}" y todas sus subcategorías?`, async () => {
                    delete categories[category];
                    await saveCategories();
                    renderCategories();
                });
            });
        });

        categoriesList.querySelectorAll('[data-action="delete-subcat"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const category = e.target.dataset.category;
                const subcategory = e.target.dataset.subcategory;
                showConfirmationModal(`¿Estás seguro de que quieres eliminar la subcategoría "${subcategory}"?`, async () => {
                    categories[category] = categories[category].filter(sub => sub !== subcategory);
                    await saveCategories();
                    renderCategories();
                });
            });
        });

        categoriesList.querySelectorAll('[data-action="add-subcat"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const category = e.target.dataset.category;
                const subcatInput = document.querySelector(`input[data-add-subcat-input="${category}"]`);
                const newSubcat = subcatInput.value.trim();
                if (newSubcat && categories[category] && !categories[category].includes(newSubcat)) {
                    categories[category].push(newSubcat);
                    await saveCategories();
                    subcatInput.value = '';
                    renderCategories();
                }
            });
        });
    }

    function closeModal() {
        const modalContent = modalContainer.querySelector('.modal-content');
        modalContent.classList.remove('modal-enter-active');
        modalContent.classList.add('modal-leave-active');
        setTimeout(() => {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }, 300);
    }

    function updateBalance(transactions) {
        let totalIncome = 0;
        let totalExpenses = 0;

        transactions.forEach(t => {
            if (t.type === 'income') {
                totalIncome += t.amount;
            } else {
                totalExpenses += t.amount;
            }
        });

        totalIncomeEl.textContent = `$${totalIncome.toLocaleString('es-CL')}`;
        totalExpensesEl.textContent = `$${totalExpenses.toLocaleString('es-CL')}`;
        const balance = totalIncome - totalExpenses;
        balanceEl.textContent = `$${balance.toLocaleString('es-CL')}`;
        balanceEl.style.color = balance >= 0 ? '#10B981' : '#EF4444';
    }

    function renderTransactions(transactions) {
        transactionsData = transactions; // Store transactions in global variable
        transactionsList.innerHTML = '';
        if (transactions.length === 0) {
            transactionsList.innerHTML = `<p class="text-center text-gray-500">No hay transacciones para este mes.</p>`;
            return;
        }
        transactions.sort((a, b) => b.timestamp - a.timestamp); // Sort by date descending
        transactions.forEach(t => {
            const transactionEl = document.createElement('div');
            const date = new Date(t.date + 'T00:00:00');
            const dateStr = date.toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
            transactionEl.className = `p-4 rounded-lg shadow-sm flex items-center justify-between ${t.type === 'income' ? 'bg-green-50' : 'bg-red-50'}`;
            transactionEl.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${t.type === 'income' ? t.description : t.subcategory}</p>
                    <p class="text-sm text-gray-500">${dateStr}</p>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0 text-right font-bold text-lg">
                    <span class="${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">$${t.amount.toLocaleString('es-CL')}</span>
                    <button data-action="edit" data-id="${t.id}" data-type="${t.type}" class="text-blue-500 hover:text-blue-700 text-sm font-normal">Editar</button>
                    <button data-action="delete" data-id="${t.id}" class="text-red-500 hover:text-red-700 text-sm font-normal">Eliminar</button>
                </div>
            `;
            transactionsList.appendChild(transactionEl);
        });

        transactionsList.querySelectorAll('[data-action="edit"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const transactionId = e.target.dataset.id;
                const transactionType = e.target.dataset.type;
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction) {
                    createTransactionModal(transactionType, transaction);
                }
            });
        });

        transactionsList.querySelectorAll('[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const transactionId = e.target.dataset.id;
                showConfirmationModal('¿Estás seguro de que quieres eliminar esta transacción?', async () => {
                    if (isAuthReady && userId) {
                        try {
                            await deleteDoc(doc(db, "artifacts", appId, "public", "data", "transactions", transactionId));
                        } catch (error) {
                            console.error("Error deleting document:", error);
                        }
                    }
                });
            });
        });
    }
    
    // Function to export transactions and records to CSV (improved for Excel with UTF-8 BOM)
    async function exportToExcel() {
        const recordsToExport = await getDocs(collection(db, "artifacts", appId, "public", "data", "records"));
        const recordsData = recordsToExport.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const transactionsHeaders = ["Fecha", "Tipo", "Descripción", "Categoría", "Subcategoría", "Monto"];
        const transactionsRows = transactionsData.map(t => {
            const date = new Date(t.date + 'T00:00:00').toLocaleDateString('es-CL');
            const type = t.type === 'income' ? 'Ingreso' : 'Gasto';
            const description = t.description || '';
            const category = t.category || '';
            const subcategory = t.subcategory || '';
            const amount = t.amount;
            return `"${date}","${type}","${description}","${category}","${subcategory}","${amount}"`;
        });

        const recordsHeaders = ["Registro", "Descripción", "Monto"];
        const recordsRows = [];
        if (recordsData.length > 0) {
            recordsData.forEach(record => {
                const entries = JSON.parse(record.entries);
                entries.forEach(entry => {
                    recordsRows.push(`"${record.name}","${entry.description}","${entry.amount}"`);
                });
            });
        }

        const csvContent = "\uFEFF" +
            "TRANSACCIONES\n" +
            transactionsHeaders.join(';') + "\n" +
            transactionsRows.join("\n").replace(/,/g, ';') +
            "\n\nREGISTROS\n" +
            recordsHeaders.join(';') + "\n" +
            recordsRows.join("\n").replace(/,/g, ';');

        const encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const monthName = monthSelect.options[monthSelect.selectedIndex].text;
        const fileName = `Finanzas-Familiares-${monthName}-${currentYear}.csv`;
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showTemporaryMessage("¡Archivo exportado!");
    }

    // New function to export a full year of transactions and records
    async function exportFullYearToExcel() {
        if (!isAuthReady || !userId) {
            showTemporaryMessage("La aplicación no está lista. Inténtalo de nuevo.");
            return;
        }

        showTemporaryMessage("Exportando año completo...");

        // Define the date range for the entire year
        const startOfYear = new Date(currentYear, 0, 1).getTime();
        const endOfYear = new Date(currentYear, 11, 31, 23, 59, 59).getTime();

        // Fetch all transactions for the selected year
        const transactionsRef = collection(db, "artifacts", appId, "public", "data", "transactions");
        const q = query(transactionsRef, where("timestamp", ">=", startOfYear), where("timestamp", "<=", endOfYear));
        
        try {
            const querySnapshot = await getDocs(q);
            const allYearTransactions = [];
            querySnapshot.forEach((doc) => {
                allYearTransactions.push({ id: doc.id, ...doc.data() });
            });

            // Fetch all records
            const recordsToExport = await getDocs(collection(db, "artifacts", appId, "public", "data", "records"));
            const allRecordsData = recordsToExport.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Prepare the data for CSV
            const cleanText = (text) => {
                if (text === null || typeof text === 'undefined') return '';
                return String(text).replace(/;/g, ' ').replace(/\n/g, ' ');
            };

            const transactionsHeaders = ["Fecha", "Tipo", "Descripción", "Categoría", "Subcategoría", "Monto"];
            const transactionsRows = allYearTransactions.map(t => {
                const date = new Date(t.date + 'T00:00:00').toLocaleDateString('es-CL');
                const type = t.type === 'income' ? 'Ingreso' : 'Gasto';
                const description = t.description || '';
                const category = t.category || '';
                const subcategory = t.subcategory || '';
                const amount = t.amount;
                return `"${date}","${type}","${description}","${category}","${subcategory}","${amount}"`;
            });

            const recordsHeaders = ["Registro", "Descripción", "Monto"];
            const recordsRows = [];
            if (allRecordsData.length > 0) {
                allRecordsData.forEach(record => {
                    const entries = JSON.parse(record.entries);
                    entries.forEach(entry => {
                        recordsRows.push(`"${record.name}","${entry.description}","${entry.amount}"`);
                    });
                });
            }

            const csvContent = "\uFEFF" +
            "TRANSACCIONES\n" +
            transactionsHeaders.join(';') + "\n" +
            transactionsRows.join("\n").replace(/,/g, ';') +
            "\n\nREGISTROS\n" +
            recordsHeaders.join(';') + "\n" +
            recordsRows.join("\n").replace(/,/g, ';');

            const encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `Finanzas-Familiares-Año-${currentYear}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showTemporaryMessage("¡Archivo de año completo exportado!");

        } catch (error) {
            console.error("Error fetching or exporting full year data:", error);
            showTemporaryMessage("Ocurrió un error al exportar.");
        }
    }

    async function initializeAppLogic() {
        if (!isAuthReady || !userId) {
            console.error("initializeAppLogic called before auth is ready.");
            return;
        }

        setupFirestoreListeners();
        setupDateSelectors();
        updateView();

        document.getElementById('add-income-btn').addEventListener('click', () => createTransactionModal('income'));
        document.getElementById('add-expense-btn').addEventListener('click', () => createTransactionModal('expense'));
        document.getElementById('manage-budgets-btn').addEventListener('click', createBudgetsModal);
        document.getElementById('manage-categories-btn').addEventListener('click', createCategoriesModal);
        document.getElementById('manage-records-btn').addEventListener('click', createRecordsModal);
        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
        document.getElementById('export-excel-year-btn').addEventListener('click', exportFullYearToExcel);
    }

    function setupFirestoreListeners() {
        if (!isAuthReady || !userId) {
            console.warn("Firestore listeners not set up: Auth not ready.");
            return;
        }

        // Unsubscribe from previous listeners if they exist
        if (unsubscribeCategories) unsubscribeCategories();
        if (unsubscribeBudgets) unsubscribeBudgets();
        if (unsubscribeRecords) unsubscribeRecords();

        // Listen for real-time updates to categories
        const categoriesRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
        unsubscribeCategories = onSnapshot(categoriesRef, async (docSnapshot) => {
            if (docSnapshot.exists()) {
                categories = docSnapshot.data();
            } else {
                // If categories don't exist, create default ones
                const defaultCategories = {
                    'Fijos del hogar': ['Dividendo', 'Luz', 'Agua', 'Gas', 'Basura', 'Wifi', 'Streaming', 'Mantención Aire', 'Plan móvil'],
                    'Alimentación': ['Supermercado', 'Feria'],
                    'Educación': ['Matrícula', 'Arancel'],
                    'Salud': ['Seguro'],
                    'Transporte': ['BIP', 'Combustible', 'Permiso circulación', 'Mantención', 'TAG'],
                    'Gin': ['Comida', 'Salud'],
                    'Eventos': ['Navidad', 'Vacaciones', 'Cumple hija', 'Cumple BR', 'Cumple DT', 'Cumpleaños'],
                    'Presupuestos individuales': ['Presupuesto BR', 'Presupuesto Hija', 'Presupuesto DT']
                };
                await setDoc(categoriesRef, defaultCategories);
                categories = defaultCategories;
            }
        }, (error) => {
            console.error("Error fetching categories:", error);
        });

        // Listen for real-time updates to budgets
        const budgetsRef = doc(db, "artifacts", appId, "public", "data", "budgets", "budgets");
        unsubscribeBudgets = onSnapshot(budgetsRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                budgets = docSnapshot.data();
            } else {
                budgets = {};
            }
        }, (error) => {
            console.error("Error fetching budgets:", error);
        });

        // Listen for real-time updates to records
        const recordsRef = collection(db, "artifacts", appId, "public", "data", "records");
        unsubscribeRecords = onSnapshot(recordsRef, (querySnapshot) => {
            recordsData = [];
            querySnapshot.forEach(doc => {
                recordsData.push({ id: doc.id, ...doc.data() });
            });
            // Re-render records if modal is open
            if (modalContainer.querySelector('#records-list')) {
                renderRecords();
            }
        }, (error) => {
            console.error("Error fetching records:", error);
        });
    }
</script>
</body>
</html>
