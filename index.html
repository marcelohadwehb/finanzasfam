<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Familiares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        /* Estilo para los botones de las secciones */
        .section-button.active {
            background-color: #e5e7eb;
        }
        .section-container {
            display: none;
        }
        .section-container.active {
            display: block;
        }
        .bg-gradient-blue-purple {
            background-image: linear-gradient(to right, #6b46c1, #3182ce);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-8">
    <div id="loading-message" class="text-center text-gray-500 font-bold text-xl my-8 hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
        Cargando...
    </div>

    <div id="content-wrapper" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-6">Finanzas Familiares</h1>
        
        <!-- Selectores de Mes y Año -->
        <div class="flex justify-center items-center space-x-4 mb-8">
            <select id="select-month" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            <select id="select-year" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
        </div>

        <!-- Secciones de navegación -->
        <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mb-8">
            <button id="nav-resumen" class="section-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors active">Resumen</button>
            <button id="nav-ingresos" class="section-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors">Ingresos</button>
            <button id="nav-gastos" class="section-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors">Gastos</button>
            <button id="nav-presupuesto" class="section-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors">Presupuesto</button>
            <button id="nav-bancos" class="section-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors">Bancos</button>
        </div>

        <!-- Contenedor de las secciones -->
        <div class="section-content">
            <!-- Sección Resumen -->
            <div id="resumen-section" class="section-container active">
                <h2 class="text-2xl font-bold mb-4">Resumen Mensual</h2>
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm mb-4">
                    <p class="text-lg font-semibold">Saldo total: <span id="saldo-total">...</span></p>
                </div>
                <div class="grid sm:grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg shadow-sm">
                        <p class="text-lg font-semibold">Total Ingresos: <span id="total-ingresos">...</span></p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg shadow-sm">
                        <p class="text-lg font-semibold">Total Gastos: <span id="total-gastos">...</span></p>
                    </div>
                </div>
                <!-- Botones de descarga de Excel -->
                <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mt-8">
                    <button id="download-monthly-excel" class="px-6 py-3 rounded-lg font-medium text-white bg-green-500 hover:bg-green-600 transition-colors">Descargar Excel (Mensual)</button>
                    <button id="download-yearly-excel" class="px-6 py-3 rounded-lg font-medium text-white bg-blue-500 hover:bg-blue-600 transition-colors">Descargar Excel (Anual)</button>
                </div>
            </div>

            <!-- Sección Ingresos -->
            <div id="ingresos-section" class="section-container">
                <h2 class="text-2xl font-bold mb-4">Gestión de Ingresos</h2>
                <form id="ingresos-form" class="bg-gray-100 p-4 rounded-lg shadow-sm mb-4">
                    <div class="grid sm:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="ingreso-descripcion" placeholder="Descripción" required class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="number" id="ingreso-monto" placeholder="Monto" required class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg font-bold hover:bg-green-600 transition-colors">Agregar Ingreso</button>
                </form>
                <div class="space-y-2" id="ingresos-list">
                    <!-- Ingresos se renderizarán aquí -->
                </div>
            </div>

            <!-- Sección Gastos -->
            <div id="gastos-section" class="section-container">
                <h2 class="text-2xl font-bold mb-4">Gestión de Gastos</h2>
                <form id="gastos-form" class="bg-gray-100 p-4 rounded-lg shadow-sm mb-4">
                    <div class="grid sm:grid-cols-2 gap-4 mb-4">
                        <select id="gasto-categoria" required class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccione Categoría</option>
                        </select>
                        <select id="gasto-subcategoria" required class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccione Subcategoría</option>
                        </select>
                    </div>
                     <div class="grid sm:grid-cols-2 gap-4 mb-4">
                        <input type="number" id="gasto-monto" placeholder="Monto" required class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600 transition-colors">Agregar Gasto</button>
                </form>
                <div class="space-y-2" id="gastos-list">
                    <!-- Gastos se renderizarán aquí -->
                </div>
            </div>

            <!-- Sección Presupuesto -->
            <div id="presupuesto-section" class="section-container">
                <h2 class="text-2xl font-bold mb-4">Gestión de Presupuestos</h2>
                 <!-- Sub-navegación para Presupuesto -->
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="nav-presupuesto-main" class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors active">Presupuestos</button>
                    <button id="nav-categorias" class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-200 transition-colors">Categorías y Subcategorías</button>
                </div>

                <div id="presupuestos-main-container" class="space-y-4">
                    <div class="space-y-4" id="presupuesto-list">
                        <!-- Presupuestos se renderizarán aquí -->
                    </div>
                </div>

                <!-- Sección de gestión de categorías y subcategorías -->
                <div id="categorias-container" class="hidden">
                    <h3 class="text-xl font-bold mb-4">Gestión de Categorías y Subcategorías</h3>
                    <div id="categories-list" class="space-y-4">
                        <!-- Categorías y subcategorías se renderizarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Sección Gestión de Bancos -->
            <div id="bancos-section" class="section-container">
                <h2 class="text-2xl font-bold mb-4">Gestión de Bancos</h2>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm mb-4">
                    <h3 class="text-xl font-bold mb-2">Registrar Nuevo Banco</h3>
                    <form id="bancos-form" class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="banco-nombre" placeholder="Nombre del Banco" required class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">Agregar Banco</button>
                    </form>
                </div>
                <div id="bancos-list" class="space-y-4">
                    <!-- Bancos se renderizarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modales (sin cambios) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center modal-enter hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Editar Ítem</h3>
            <form id="edit-form">
                <div class="mb-4">
                    <label for="edit-descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="edit-descripcion" required class="mt-1 p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="edit-monto" class="block text-sm font-medium text-gray-700">Monto</label>
                    <input type="number" id="edit-monto" required class="mt-1 p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-edit" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center modal-enter hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4">¿Estás seguro de que quieres eliminar?</h3>
            <p class="text-sm text-gray-600 mb-4">Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-2">
                <button type="button" id="cancel-delete" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400">Cancelar</button>
                <button type="button" id="confirm-delete" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="bank-movement-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center modal-enter hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4" id="bank-movement-modal-title"></h3>
            <form id="bank-movement-form">
                <div class="mb-4">
                    <label for="bank-movement-descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="bank-movement-descripcion" required class="mt-1 p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="bank-movement-monto" class="block text-sm font-medium text-gray-700">Monto (CLP)</label>
                    <input type="number" id="bank-movement-monto" required class="mt-1 p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-bank-movement" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="category-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center modal-enter hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="category-modal-title"></h3>
            <form id="category-form">
                <div class="mb-4">
                    <label for="category-name-input" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="category-name-input" required class="mt-1 p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-category-edit" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600">Guardar</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, updateDoc, deleteDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and other data
        let app;
        let db;
        let auth;
        let unsubscribeIngresos;
        let unsubscribeGastos;
        let unsubscribeCategories;
        let unsubscribeBudgets;
        let unsubscribeBancos;
        let unsubscribeBankMovements = {};

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let userId = null;
        let ingresos = [];
        let gastos = [];
        let budgets = {};
        let categories = {};
        let bancos = {};
        let activeEditItem = null;
        let activeBankId = null;
        let currentCategoryOperation = null;

        let currentMonth;
        let currentYear;

        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(amount);
        };

        const showSection = (sectionId) => {
            document.querySelectorAll('.section-container').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.section-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${sectionId.split('-')[0]}`).classList.add('active');
            
            // Render specific content for each section when shown
            if (sectionId === 'resumen-section') {
                renderResumen();
            } else if (sectionId === 'presupuesto-section') {
                showPresupuestoSection('main');
            } else if (sectionId === 'bancos-section') {
                renderBancos();
            }
        };

        const showPresupuestoSection = (type) => {
            if (type === 'main') {
                document.getElementById('presupuestos-main-container').classList.remove('hidden');
                document.getElementById('categorias-container').classList.add('hidden');
                document.getElementById('nav-presupuesto-main').classList.add('active');
                document.getElementById('nav-categorias').classList.remove('active');
                renderPresupuestos();
            } else {
                document.getElementById('presupuestos-main-container').classList.add('hidden');
                document.getElementById('categorias-container').classList.remove('hidden');
                document.getElementById('nav-presupuesto-main').classList.remove('active');
                document.getElementById('nav-categorias').classList.add('active');
                renderCategoriesAndSubcategories();
            }
        };

        const setupEventListeners = () => {
            document.querySelectorAll('.section-button').forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.id.replace('nav-', '') + '-section';
                    showSection(sectionId);
                });
            });

            // Sub-navigation for Presupuesto section
            document.getElementById('nav-presupuesto-main').addEventListener('click', () => showPresupuestoSection('main'));
            document.getElementById('nav-categorias').addEventListener('click', () => showPresupuestoSection('categories'));

            // Handle Ingresos form
            document.getElementById('ingresos-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const descripcion = document.getElementById('ingreso-descripcion').value;
                const monto = parseInt(document.getElementById('ingreso-monto').value, 10);
                if (descripcion && !isNaN(monto)) {
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "ingresos"), { descripcion, monto, year: currentYear, month: currentMonth, timestamp: Date.now() });
                    document.getElementById('ingresos-form').reset();
                }
            });

            // Handle Gastos form
            document.getElementById('gastos-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const monto = parseInt(document.getElementById('gasto-monto').value, 10);
                const categoria = document.getElementById('gasto-categoria').value;
                const subcategoria = document.getElementById('gasto-subcategoria').value;
                if (!isNaN(monto) && categoria && subcategoria) {
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "gastos"), { descripcion: subcategoria, monto, categoria, subcategoria, year: currentYear, month: currentMonth, timestamp: Date.now() });
                    document.getElementById('gastos-form').reset();
                }
            });
            
            // Handle Bancos form
            document.getElementById('bancos-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombreBanco = document.getElementById('banco-nombre').value;
                if (nombreBanco) {
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "bancos"), { nombre: nombreBanco, movimientos: [] });
                    document.getElementById('bancos-form').reset();
                }
            });

            // Handle edit modal
            document.getElementById('edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (activeEditItem) {
                    if (activeEditItem.collection === 'budgets') {
                        const newMonto = parseInt(document.getElementById('edit-monto').value, 10);
                        const docRef = doc(db, "artifacts", appId, "users", userId, "budgets", `${currentYear}-${currentMonth}`);
                        await setDoc(docRef, { [activeEditItem.field]: newMonto }, { merge: true });
                        document.getElementById('edit-descripcion').disabled = false;
                    } else {
                        const newDescripcion = document.getElementById('edit-descripcion').value;
                        const newMonto = parseInt(document.getElementById('edit-monto').value, 10);
                        const itemDocRef = doc(db, "artifacts", appId, "users", userId, activeEditItem.collection, activeEditItem.id);
                        await updateDoc(itemDocRef, { descripcion: newDescripcion, monto: newMonto });
                    }
                    hideModal('edit-modal');
                }
            });

            // Handle delete confirmation
            document.getElementById('confirm-delete').addEventListener('click', async () => {
                if (activeEditItem) {
                    if (activeEditItem.collection === 'bankMovements') {
                         const bankDocRef = doc(db, "artifacts", appId, "users", userId, "bancos", activeEditItem.id);
                         const docSnapshot = await getDoc(bankDocRef);
                         if (docSnapshot.exists()) {
                             const movimientos = docSnapshot.data().movimientos;
                             movimientos.splice(activeEditItem.index, 1);
                             await updateDoc(bankDocRef, { movimientos });
                         }
                    } else if (activeEditItem.collection === 'categories') {
                         const docRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
                         const docSnapshot = await getDoc(docRef);
                         if (docSnapshot.exists()) {
                            const updatedCategories = docSnapshot.data();
                            delete updatedCategories[activeEditItem.id];
                            await setDoc(docRef, updatedCategories);
                         }
                    } else if (activeEditItem.collection === 'subcategories') {
                         const docRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
                         const docSnapshot = await getDoc(docRef);
                         if (docSnapshot.exists()) {
                            const updatedCategories = docSnapshot.data();
                            updatedCategories[activeEditItem.categoryId] = updatedCategories[activeEditItem.categoryId].filter(subcat => subcat !== activeEditItem.id);
                            await setDoc(docRef, updatedCategories);
                         }
                    } else {
                        const itemDocRef = doc(db, "artifacts", appId, "users", userId, activeEditItem.collection, activeEditItem.id);
                        await deleteDoc(itemDocRef);
                    }
                    hideModal('confirm-modal');
                }
            });

            document.getElementById('cancel-edit').addEventListener('click', () => {
                document.getElementById('edit-descripcion').disabled = false;
                hideModal('edit-modal');
            });
            document.getElementById('cancel-delete').addEventListener('click', () => hideModal('confirm-modal'));
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') hideModal('edit-modal');
            });
            document.getElementById('confirm-modal').addEventListener('click', (e) => {
                if (e.target.id === 'confirm-modal') hideModal('confirm-modal');
            });

            // Handle bank movement modal
            document.getElementById('bank-movement-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const descripcion = document.getElementById('bank-movement-descripcion').value;
                const monto = parseInt(document.getElementById('bank-movement-monto').value, 10);
                const bankDocRef = doc(db, "artifacts", appId, "users", userId, "bancos", activeBankId);
                const docSnapshot = await getDoc(bankDocRef);
                
                if (docSnapshot.exists() && descripcion && !isNaN(monto)) {
                    const currentMovements = docSnapshot.data().movimientos || [];
                    const mode = e.target.dataset.mode;
                    if (mode === 'add') {
                        await updateDoc(bankDocRef, { movimientos: [...currentMovements, { descripcion, monto, timestamp: Date.now() }] });
                    } else if (mode === 'edit') {
                        const index = parseInt(e.target.dataset.index, 10);
                        currentMovements[index] = { descripcion, monto, timestamp: Date.now() };
                        await updateDoc(bankDocRef, { movimientos: currentMovements });
                    }
                    hideModal('bank-movement-modal');
                }
            });

            document.getElementById('cancel-bank-movement').addEventListener('click', () => hideModal('bank-movement-modal'));
            document.getElementById('bank-movement-modal').addEventListener('click', (e) => {
                if (e.target.id === 'bank-movement-modal') hideModal('bank-movement-modal');
            });

            // Handle category modal
            document.getElementById('category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = document.getElementById('category-name-input').value;
                if (!newName) return;
                
                const categoriesRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
                const docSnapshot = await getDoc(categoriesRef);
                const currentCategories = docSnapshot.exists() ? docSnapshot.data() : {};
                
                if (currentCategoryOperation.type === 'addCategory') {
                    if (currentCategories[newName]) {
                        console.log("Esa categoría ya existe."); 
                        return;
                    }
                    currentCategories[newName] = [];
                } else if (currentCategoryOperation.type === 'addSubcategory') {
                    const categoryId = currentCategoryOperation.id;
                    if (currentCategories[categoryId].includes(newName)) {
                        console.log("Esa subcategoría ya existe."); 
                        return;
                    }
                    currentCategories[categoryId].push(newName);
                } else if (currentCategoryOperation.type === 'editCategory') {
                    const oldName = currentCategoryOperation.id;
                    const subcategories = currentCategories[oldName];
                    delete currentCategories[oldName];
                    currentCategories[newName] = subcategories;
                } else if (currentCategoryOperation.type === 'editSubcategory') {
                    const categoryId = currentCategoryOperation.categoryId;
                    const oldName = currentCategoryOperation.id;
                    const subcategories = currentCategories[categoryId];
                    const index = subcategories.indexOf(oldName);
                    if (index !== -1) {
                        subcategories[index] = newName;
                    }
                }
                
                await setDoc(categoriesRef, currentCategories);
                hideModal('category-modal');
            });
            
            document.getElementById('cancel-category-edit').addEventListener('click', () => hideModal('category-modal'));
            document.getElementById('category-modal').addEventListener('click', (e) => {
                if (e.target.id === 'category-modal') hideModal('category-modal');
            });

            // Update subcategory options based on category selection
            const categoriaSelect = document.getElementById('gasto-categoria');
            const subcategoriaSelect = document.getElementById('gasto-subcategoria');
            categoriaSelect.addEventListener('change', () => {
                const selectedCategory = categoriaSelect.value;
                subcategoriaSelect.innerHTML = '<option value="">Seleccione Subcategoría</option>';
                if (selectedCategory && categories[selectedCategory]) {
                    categories[selectedCategory].forEach(subcat => {
                        const option = document.createElement('option');
                        option.value = subcat;
                        option.textContent = subcat;
                        subcategoriaSelect.appendChild(option);
                    });
                }
            });

            // Excel download buttons
            document.getElementById('download-monthly-excel').addEventListener('click', exportToExcelMonthly);
            document.getElementById('download-yearly-excel').addEventListener('click', exportToExcelYearly);
        };

        const exportToExcelMonthly = () => {
            const currentMonthName = months[currentMonth - 1];
            const wb = XLSX.utils.book_new();

            // Hoja de Resumen
            const resumenData = [
                ['Resumen Mensual', `${currentMonthName}, ${currentYear}`],
                ['Total Ingresos', totalIngresos],
                ['Total Gastos', totalGastos],
                ['Saldo Total', saldoTotal]
            ];
            const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
            XLSX.utils.book_append_sheet(wb, wsResumen, "Resumen");

            // Hoja de Ingresos
            const ingresosHeaders = ['Descripción', 'Monto (CLP)', 'Fecha'];
            const ingresosData = ingresos.map(i => [i.descripcion, i.monto, new Date(i.timestamp).toLocaleDateString('es-CL')]);
            const wsIngresos = XLSX.utils.aoa_to_sheet([ingresosHeaders, ...ingresosData]);
            XLSX.utils.book_append_sheet(wb, wsIngresos, "Ingresos");

            // Hoja de Gastos
            const gastosHeaders = ['Descripción', 'Categoría', 'Subcategoría', 'Monto (CLP)', 'Fecha'];
            const gastosData = gastos.map(g => [g.descripcion, g.categoria, g.subcategoria, g.monto, new Date(g.timestamp).toLocaleDateString('es-CL')]);
            const wsGastos = XLSX.utils.aoa_to_sheet([gastosHeaders, ...gastosData]);
            XLSX.utils.book_append_sheet(wb, wsGastos, "Gastos");

            XLSX.writeFile(wb, `Finanzas_Mensual_${currentMonthName}_${currentYear}.xlsx`);
        };

        const exportToExcelYearly = async () => {
            const wb = XLSX.utils.book_new();

            // Fetch all data for the year
            const ingresosQuery = query(collection(db, "artifacts", appId, "users", userId, "ingresos"), where("year", "==", currentYear));
            const gastosQuery = query(collection(db, "artifacts", appId, "users", userId, "gastos"), where("year", "==", currentYear));
            
            const [ingresosSnapshot, gastosSnapshot] = await Promise.all([
                getDocs(ingresosQuery),
                getDocs(gastosQuery)
            ]);

            const allIngresos = ingresosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const allGastos = gastosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Hoja de Resumen Anual
            const totalIngresosAnual = allIngresos.reduce((sum, item) => sum + item.monto, 0);
            const totalGastosAnual = allGastos.reduce((sum, item) => sum + item.monto, 0);
            const saldoTotalAnual = totalIngresosAnual - totalGastosAnual;
            const resumenAnualData = [
                ['Resumen Anual', currentYear],
                ['Total Ingresos Anual', totalIngresosAnual],
                ['Total Gastos Anual', totalGastosAnual],
                ['Saldo Total Anual', saldoTotalAnual]
            ];
            const wsResumenAnual = XLSX.utils.aoa_to_sheet(resumenAnualData);
            XLSX.utils.book_append_sheet(wb, wsResumenAnual, "Resumen Anual");

            // Hoja de Ingresos Anuales
            const ingresosHeaders = ['Descripción', 'Monto (CLP)', 'Mes', 'Año', 'Fecha'];
            const ingresosData = allIngresos.map(i => [i.descripcion, i.monto, i.month, i.year, new Date(i.timestamp).toLocaleDateString('es-CL')]);
            const wsIngresosAnuales = XLSX.utils.aoa_to_sheet([ingresosHeaders, ...ingresosData]);
            XLSX.utils.book_append_sheet(wb, wsIngresosAnuales, "Ingresos Anuales");

            // Hoja de Gastos Anuales
            const gastosHeaders = ['Descripción', 'Categoría', 'Subcategoría', 'Monto (CLP)', 'Mes', 'Año', 'Fecha'];
            const gastosData = allGastos.map(g => [g.descripcion, g.categoria, g.subcategoria, g.monto, g.month, g.year, new Date(g.timestamp).toLocaleDateString('es-CL')]);
            const wsGastosAnuales = XLSX.utils.aoa_to_sheet([gastosHeaders, ...gastosData]);
            XLSX.utils.book_append_sheet(wb, wsGastosAnuales, "Gastos Anuales");

            XLSX.writeFile(wb, `Finanzas_Anual_${currentYear}.xlsx`);
        };


        const showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-enter-active'), 10);
        };

        const hideModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('modal-enter-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        let totalIngresos = 0;
        let totalGastos = 0;
        let saldoTotal = 0;

        const renderIngresos = () => {
            const list = document.getElementById('ingresos-list');
            list.innerHTML = '';
            ingresos.sort((a, b) => b.timestamp - a.timestamp);
            ingresos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="font-medium">${item.descripcion}</p>
                        <p class="text-sm text-gray-600">${formatCurrency(item.monto)}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-bold" data-id="${item.id}" data-collection="ingresos">Editar</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-bold" data-id="${item.id}" data-collection="ingresos">Eliminar</button>
                    </div>
                `;
                list.appendChild(div);
            });
            addEditDeleteListeners();
        };

        const renderGastos = () => {
            const list = document.getElementById('gastos-list');
            list.innerHTML = '';
            gastos.sort((a, b) => b.timestamp - a.timestamp);
            gastos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${item.descripcion}</p>
                        <p class="text-xs text-gray-600">${item.categoria} / ${item.subcategoria}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-bold" data-id="${item.id}" data-collection="gastos">Editar</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-bold" data-id="${item.id}" data-collection="gastos">Eliminar</button>
                    </div>
                `;
                list.appendChild(div);
            });
            addEditDeleteListeners();
        };

        const renderResumen = () => {
            totalIngresos = ingresos.reduce((sum, item) => sum + item.monto, 0);
            totalGastos = gastos.reduce((sum, item) => sum + item.monto, 0);
            saldoTotal = totalIngresos - totalGastos;

            document.getElementById('total-ingresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('total-gastos').textContent = formatCurrency(totalGastos);
            document.getElementById('saldo-total').textContent = formatCurrency(saldoTotal);
        };


        const renderPresupuestos = () => {
            const list = document.getElementById('presupuesto-list');
            list.innerHTML = '';
            
            const totalGastosPorSubcategoria = gastos.reduce((acc, item) => {
                const key = item.subcategoria;
                acc[key] = (acc[key] || 0) + item.monto;
                return acc;
            }, {});

            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                const totalCategoryBudget = categories[category].reduce((sum, subcat) => sum + (budgets[subcat] || 0), 0);
                
                let categoryHtml = `
                    <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-200">
                        <h3 class="font-bold text-lg text-gray-800">${category}</h3>
                        <p class="text-sm font-bold text-gray-600">Total: ${formatCurrency(totalCategoryBudget)}</p>
                    </div>
                `;

                categories[category].forEach(subcat => {
                    const presupuestoMonto = budgets[subcat] || 0;
                    const gastoSubcat = totalGastosPorSubcategoria[subcat] || 0;
                    const remainingSubcat = presupuestoMonto - gastoSubcat;
                    const subcatStatusColor = remainingSubcat > 0 ? 'text-green-500' : (remainingSubcat < 0 ? 'text-red-500' : 'text-gray-500');

                    categoryHtml += `
                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm">${subcat}</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">Presupuesto: ${formatCurrency(presupuestoMonto)}</span>
                                <span class="text-sm text-gray-600">Gastado: ${formatCurrency(gastoSubcat)}</span>
                                <span class="text-sm font-semibold ${subcatStatusColor}">Diferencia: ${formatCurrency(remainingSubcat)}</span>
                                <button class="edit-presupuesto-btn text-blue-500 hover:text-blue-700" data-subcat="${subcat}">Editar</button>
                            </div>
                        </div>
                    `;
                });
                categoryDiv.innerHTML = categoryHtml;
                list.appendChild(categoryDiv);
            }

            document.querySelectorAll('.edit-presupuesto-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const subcat = e.target.dataset.subcat;
                    const montoActual = budgets[subcat] || 0;
                    
                    document.getElementById('modal-title').textContent = `Editar Presupuesto de ${subcat}`;
                    document.getElementById('edit-descripcion').value = subcat;
                    document.getElementById('edit-descripcion').disabled = true;
                    document.getElementById('edit-monto').value = montoActual;
                    
                    activeEditItem = {
                        id: 'budgets',
                        collection: 'budgets',
                        field: subcat
                    };
                    showModal('edit-modal');
                });
            });
        };
        
        const renderCategoriesAndSubcategories = () => {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            
            const addCategoryDiv = document.createElement('div');
            addCategoryDiv.className = 'bg-gray-100 p-4 rounded-lg shadow-sm mb-4';
            addCategoryDiv.innerHTML = `
                <h4 class="font-bold text-lg mb-2">Agregar Categoría</h4>
                <form id="add-category-form" class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="new-category-name" placeholder="Nombre de la categoría" required class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">Agregar</button>
                </form>
            `;
            list.appendChild(addCategoryDiv);
            
            document.getElementById('add-category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newCategoryName = document.getElementById('new-category-name').value;
                if (!newCategoryName) return;

                const categoriesRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
                const docSnapshot = await getDoc(categoriesRef);
                const currentCategories = docSnapshot.exists() ? docSnapshot.data() : {};

                if (currentCategories[newCategoryName]) {
                    console.log("Esa categoría ya existe."); 
                    return;
                }
                currentCategories[newCategoryName] = [];
                await setDoc(categoriesRef, currentCategories);
                document.getElementById('new-category-name').value = '';
            });

            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                let subcategoriesHtml = categories[category].map(subcat => `
                    <div class="flex items-center justify-between py-1 px-2 rounded-md hover:bg-white transition-colors">
                        <span class="text-sm">${subcat}</span>
                        <div class="flex space-x-2">
                            <button class="edit-subcategory-btn text-blue-500 hover:text-blue-700" data-category="${category}" data-subcat="${subcat}">Editar</button>
                            <button class="delete-subcategory-btn text-red-500 hover:text-red-700" data-category="${category}" data-subcat="${subcat}">Eliminar</button>
                        </div>
                    </div>
                `).join('');
                
                categoryDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-200">
                        <h3 class="font-bold text-lg text-gray-800">${category}</h3>
                        <div class="flex space-x-2">
                            <button class="add-subcategory-btn text-green-500 hover:text-green-700" data-category="${category}">Agregar Subcategoría</button>
                            <button class="edit-category-btn text-blue-500 hover:text-blue-700" data-category="${category}">Editar</button>
                            <button class="delete-category-btn text-red-500 hover:text-red-700" data-category="${category}">Eliminar</button>
                        </div>
                    </div>
                    <div class="space-y-1">${subcategoriesHtml}</div>
                `;
                list.appendChild(categoryDiv);
            }

            document.querySelectorAll('.add-subcategory-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryId = e.target.dataset.category;
                    document.getElementById('category-modal-title').textContent = `Agregar Subcategoría a ${categoryId}`;
                    document.getElementById('category-name-input').value = '';
                    currentCategoryOperation = { type: 'addSubcategory', id: categoryId };
                    showModal('category-modal');
                });
            });

            document.querySelectorAll('.edit-category-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryId = e.target.dataset.category;
                    document.getElementById('category-modal-title').textContent = `Editar Categoría`;
                    document.getElementById('category-name-input').value = categoryId;
                    currentCategoryOperation = { type: 'editCategory', id: categoryId };
                    showModal('category-modal');
                });
            });
            
            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeEditItem = {
                        id: e.target.dataset.category,
                        collection: "categories"
                    };
                    showModal('confirm-modal');
                });
            });

            document.querySelectorAll('.edit-subcategory-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryId = e.target.dataset.category;
                    const subcatId = e.target.dataset.subcat;
                    document.getElementById('category-modal-title').textContent = `Editar Subcategoría`;
                    document.getElementById('category-name-input').value = subcatId;
                    currentCategoryOperation = { type: 'editSubcategory', categoryId: categoryId, id: subcatId };
                    showModal('category-modal');
                });
            });
            
            document.querySelectorAll('.delete-subcategory-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeEditItem = {
                        id: e.target.dataset.subcat,
                        categoryId: e.target.dataset.category,
                        collection: "subcategories"
                    };
                    showModal('confirm-modal');
                });
            });
        };


        const renderBancos = () => {
            const list = document.getElementById('bancos-list');
            list.innerHTML = '';
            
            for (const id in bancos) {
                const banco = bancos[id];
                const totalBalance = banco.movimientos.reduce((sum, mov) => sum + mov.monto, 0);
                const bancoDiv = document.createElement('div');
                bancoDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                bancoDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold text-lg text-gray-800">${banco.nombre}</h3>
                        <div class="flex space-x-2">
                            <button class="add-movement-btn text-blue-500 hover:text-blue-700 font-bold" data-id="${id}">Agregar</button>
                            <button class="delete-bank-btn text-red-500 hover:text-red-700 font-bold" data-id="${id}">Eliminar</button>
                        </div>
                    </div>
                    <div class="mb-2">
                         <p class="font-semibold text-gray-700">Saldo: <span class="${totalBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalBalance)}</span></p>
                    </div>
                    <div id="movimientos-${id}" class="space-y-2">
                        <!-- Movimientos del banco se renderizarán aquí -->
                    </div>
                `;
                list.appendChild(bancoDiv);
                renderBankMovements(id, banco.movimientos);
            }
            
            document.querySelectorAll('.add-movement-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeBankId = e.target.dataset.id;
                    const bancoNombre = bancos[activeBankId].nombre;
                    document.getElementById('bank-movement-modal-title').textContent = `Agregar movimiento a ${bancoNombre}`;
                    document.getElementById('bank-movement-descripcion').value = '';
                    document.getElementById('bank-movement-monto').value = '';
                    document.getElementById('bank-movement-form').dataset.mode = 'add';
                    showModal('bank-movement-modal');
                });
            });

            document.querySelectorAll('.delete-bank-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeEditItem = {
                        id: e.target.dataset.id,
                        collection: "bancos"
                    };
                    showModal('confirm-modal');
                });
            });
        };

        const renderBankMovements = (bankId, movements = []) => {
            const movementsList = document.getElementById(`movimientos-${bankId}`);
            movementsList.innerHTML = '';
            movements.forEach((mov, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-white p-2 rounded-lg shadow-sm';
                itemDiv.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${mov.descripcion}</p>
                        <p class="text-xs text-gray-600">${formatCurrency(mov.monto)}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-movement-btn text-blue-500 hover:text-blue-700 font-bold" data-bank-id="${bankId}" data-index="${index}">Editar</button>
                        <button class="delete-movement-btn text-red-500 hover:text-red-700 font-bold" data-bank-id="${bankId}" data-index="${index}">Eliminar</button>
                    </div>
                `;
                movementsList.appendChild(itemDiv);
            });

            document.querySelectorAll('.edit-movement-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bankId = e.target.dataset.bankId;
                    const index = parseInt(e.target.dataset.index, 10);
                    const movement = bancos[bankId].movimientos[index];
                    
                    activeBankId = bankId;
                    document.getElementById('bank-movement-modal-title').textContent = `Editar movimiento de ${bancos[bankId].nombre}`;
                    document.getElementById('bank-movement-descripcion').value = movement.descripcion;
                    document.getElementById('bank-movement-monto').value = movement.monto;
                    document.getElementById('bank-movement-form').dataset.mode = 'edit';
                    document.getElementById('bank-movement-form').dataset.index = index;

                    showModal('bank-movement-modal');
                });
            });

            document.querySelectorAll('.delete-movement-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeEditItem = {
                        id: e.target.dataset.bankId,
                        index: parseInt(e.target.dataset.index, 10),
                        collection: "bankMovements"
                    };
                    showModal('confirm-modal');
                });
            });
        };

        const addEditDeleteListeners = () => {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const collection = e.target.dataset.collection;
                    const item = collection === 'ingresos' ? ingresos.find(i => i.id === id) : gastos.find(g => g.id === id);
                    if (item) {
                        activeEditItem = { id, collection };
                        document.getElementById('modal-title').textContent = `Editar ${collection === 'ingresos' ? 'Ingreso' : 'Gasto'}`;
                        document.getElementById('edit-descripcion').value = item.descripcion;
                        document.getElementById('edit-monto').value = item.monto;
                        document.getElementById('edit-descripcion').disabled = (collection === 'gastos');
                        showModal('edit-modal');
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeEditItem = {
                        id: e.target.dataset.id,
                        collection: e.target.dataset.collection
                    };
                    showModal('confirm-modal');
                });
            });
        };

        const setupInitialData = async () => {
            // Unsubscribe existing listeners
            if (unsubscribeIngresos) unsubscribeIngresos();
            if (unsubscribeGastos) unsubscribeGastos();
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeBudgets) unsubscribeBudgets();
            if (unsubscribeBancos) unsubscribeBancos();
            for (const id in unsubscribeBankMovements) {
                if (unsubscribeBankMovements[id]) unsubscribeBankMovements[id]();
            }
            unsubscribeBankMovements = {};

            // Listen for real-time updates to categories (public data)
            const categoriesRef = doc(db, "artifacts", appId, "public", "data", "categories", "categories");
            unsubscribeCategories = onSnapshot(categoriesRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    categories = docSnapshot.data();
                } else {
                    // Create default categories if they don't exist
                    const defaultCategories = {
                        'Fijos del hogar': ['Dividendo', 'Luz', 'Agua', 'Gas', 'Basura', 'Wifi', 'Streaming', 'Mantención Aire', 'Plan móvil'],
                        'Alimentación': ['Supermercado', 'Feria'],
                        'Educación': ['Matrícula', 'Arancel'],
                        'Salud': ['Seguro'],
                        'Transporte': ['BIP', 'Combustible', 'Permiso circulación', 'Mantención', 'TAG'],
                        'Gin': ['Comida', 'Salud'],
                        'Eventos': ['Navidad', 'Vacaciones', 'Cumple hija', 'Cumple BR', 'Cumple DT', 'Cumpleaños'],
                        'Presupuestos individuales': ['Presupuesto BR', 'Presupuesto Hija', 'Presupuesto DT']
                    };
                    await setDoc(categoriesRef, defaultCategories);
                    categories = defaultCategories;
                }
                // Update select options for gastos
                const categoriaSelect = document.getElementById('gasto-categoria');
                categoriaSelect.innerHTML = '<option value="">Seleccione Categoría</option>';
                for (const category in categories) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoriaSelect.appendChild(option);
                }
                
                renderCategoriesAndSubcategories();

            }, (error) => {
                console.error("Error fetching categories:", error);
            });

            // Listen for real-time updates to budgets (private data)
            const budgetsRef = doc(db, "artifacts", appId, "users", userId, "budgets", `${currentYear}-${currentMonth}`);
            unsubscribeBudgets = onSnapshot(budgetsRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    budgets = docSnapshot.data();
                } else {
                    budgets = {};
                }
                renderResumen();
                renderPresupuestos();
            }, (error) => {
                console.error("Error fetching budgets:", error);
            });

            // Listen for real-time updates to ingresos (private data)
            const ingresosQuery = query(collection(db, "artifacts", appId, "users", userId, "ingresos"), where("year", "==", currentYear), where("month", "==", currentMonth));
            unsubscribeIngresos = onSnapshot(ingresosQuery, (querySnapshot) => {
                ingresos = [];
                querySnapshot.forEach((doc) => {
                    ingresos.push({ id: doc.id, ...doc.data() });
                });
                renderIngresos();
                renderResumen();
            }, (error) => {
                console.error("Error fetching ingresos:", error);
            });

            // Listen for real-time updates to gastos (private data)
            const gastosQuery = query(collection(db, "artifacts", appId, "users", userId, "gastos"), where("year", "==", currentYear), where("month", "==", currentMonth));
            unsubscribeGastos = onSnapshot(gastosQuery, (querySnapshot) => {
                gastos = [];
                querySnapshot.forEach((doc) => {
                    gastos.push({ id: doc.id, ...doc.data() });
                });
                renderGastos();
                renderResumen();
            }, (error) => {
                console.error("Error fetching gastos:", error);
            });

            // Listen for real-time updates to bancos (private data)
            const bancosCollectionRef = collection(db, "artifacts", appId, "users", userId, "bancos");
            unsubscribeBancos = onSnapshot(bancosCollectionRef, (querySnapshot) => {
                bancos = {};
                querySnapshot.forEach((doc) => {
                    bancos[doc.id] = doc.data();
                });
                renderBancos();
            }, (error) => {
                console.error("Error fetching bancos:", error);
            });
        };

        const showLoading = () => {
            document.getElementById('loading-message').classList.remove('hidden');
            document.getElementById('content-wrapper').classList.add('hidden');
        };

        const hideLoading = () => {
            document.getElementById('loading-message').classList.add('hidden');
            document.getElementById('content-wrapper').classList.remove('hidden');
        };

        const initializeDateSelectors = () => {
            const monthSelect = document.getElementById('select-month');
            const yearSelect = document.getElementById('select-year');
            const current = new Date();
            currentMonth = current.getMonth() + 1;
            currentYear = current.getFullYear();

            // Populate months
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                if (index + 1 === current.getMonth() + 1) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });

            // Populate years
            for (let year = 2025; year <= 2060; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === current.getFullYear()) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            if (currentYear < 2025 || currentYear > 2060) {
                 yearSelect.value = 2025;
                 currentYear = 2025;
            }

            monthSelect.addEventListener('change', (e) => {
                currentMonth = parseInt(e.target.value, 10);
                setupInitialData();
            });

            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value, 10);
                setupInitialData();
            });
        };

        window.onload = async () => {
            showLoading();
            initializeDateSelectors();
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await setupInitialData();
                    setupEventListeners();
                    hideLoading();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth error:", error);
                        hideLoading();
                    }
                }
            });
        };

    </script>
</body>
</html>
