import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, doc, addDoc, runTransaction } from 'firebase/firestore';

// Define the Firebase configuration using the provided global variable
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

// Define the App ID using the provided global variable
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Initialize Firebase with the provided configuration
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Use Tailwind CSS for styling (assumed to be available)
const tailwindCssScript = document.createElement('script');
tailwindCssScript.src = 'https://cdn.tailwindcss.com';
document.head.appendChild(tailwindCssScript);

const App = () => {
  const [user, setUser] = useState(null);
  const [editor, setEditor] = useState('');
  const [data, setData] = useState({});
  const [loading, setLoading] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [view, setView] = useState('summary');
  const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
  const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);

  // States for forms
  const [incomeForm, setIncomeForm] = useState({ date: '', description: '', amount: '' });
  const [expenseForm, setExpenseForm] = useState({ date: '', category: '', subcategory: '', amount: '' });
  const [budgetForm, setBudgetForm] = useState({ category: '', subcategory: '', budget: '' });

  // States for modals
  const [showEditorModal, setShowEditorModal] = useState(true);
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [newCategory, setNewCategory] = useState({ name: '', subcategories: [{ name: '', budget: '' }] });
  const [categoryManagement, setCategoryManagement] = useState({ selectedCategory: '', selectedSubcategory: '', newName: '' });

  // Auth Listener and Data Fetching
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        setUser(user);
        setIsAuthReady(true);
      } else {
        // Sign in with the custom token or anonymously if not available
        try {
          if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Error signing in:", error);
          setIsAuthReady(true); // Ensure auth ready state is updated even on error
        }
      }
    });

    return () => unsubscribe();
  }, []);

  // Fetch data from Firestore
  useEffect(() => {
    if (!isAuthReady || !editor) {
      setLoading(true);
      return;
    }

    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);

    const unsubscribe = onSnapshot(financeDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setData(docSnap.data());
      } else {
        setData({
          incomes: [],
          expenses: [],
          budgets: {
            'Fijos del hogar': {
              'Dividendo': 0, 'Luz': 0, 'Agua': 0, 'Gas': 0, 'Basura': 0, 'Wifi': 0, 'Streaming': 0, 'Mantención Aire': 0, 'Plan móvil': 0
            },
            'Alimentación': {
              'Supermercado': 0, 'Feria': 0
            },
            'Educación': {
              'Matrícula': 0, 'Arancel': 0
            },
            'Salud': {
              'Seguro': 0
            },
            'Transporte': {
              'BIP': 0, 'Combustible': 0, 'Permiso circulación': 0, 'Mantención': 0, 'TAG': 0
            },
            'Gin': {
              'Comida': 0, 'Salud': 0
            },
            'Eventos': {
              'Navidad': 0, 'Vacaciones': 0, 'Cumple hija': 0, 'Cumple BR': 0, 'Cumple DT': 0, 'Cumpleaños': 0
            },
            'Presupuestos individuales': {
              'Presupuesto BR': 0, 'Presupuesto Hija': 0, 'Presupuesto DT': 0
            }
          }
        });
      }
      setLoading(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, editor]);

  // Handle month and year change
  const handleDateChange = (type) => {
    let newMonth = currentMonth;
    let newYear = currentYear;
    if (type === 'next') {
      newMonth = newMonth === 12 ? 1 : newMonth + 1;
      newYear = newMonth === 1 ? newYear + 1 : newYear;
    } else {
      newMonth = newMonth === 1 ? 12 : newMonth - 1;
      newYear = newMonth === 12 ? newYear - 1 : newYear;
    }
    setCurrentMonth(newMonth);
    setCurrentYear(newYear);
  };

  // Filter data by current month and year
  const filteredIncomes = data.incomes?.filter(inc => {
    const incDate = new Date(inc.date);
    return incDate.getFullYear() === currentYear && incDate.getMonth() + 1 === currentMonth;
  }) || [];

  const filteredExpenses = data.expenses?.filter(exp => {
    const expDate = new Date(exp.date);
    return expDate.getFullYear() === currentYear && expDate.getMonth() + 1 === currentMonth;
  }) || [];

  const totalIncomes = filteredIncomes.reduce((acc, inc) => acc + parseFloat(inc.amount), 0);
  const totalExpenses = filteredExpenses.reduce((acc, exp) => acc + parseFloat(exp.amount), 0);
  const monthlyBalance = totalIncomes - totalExpenses;

  // Handle form submissions
  const handleIncomeSubmit = async (e) => {
    e.preventDefault();
    if (!incomeForm.date || !incomeForm.description || !incomeForm.amount) return;
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);

    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }

      const currentIncomes = financeDoc.data().incomes || [];
      const updatedIncomes = [...currentIncomes, {
        ...incomeForm,
        amount: parseFloat(incomeForm.amount)
      }];

      transaction.update(financeDocRef, { incomes: updatedIncomes });
    });

    setIncomeForm({ date: '', description: '', amount: '' });
  };

  const handleExpenseSubmit = async (e) => {
    e.preventDefault();
    if (!expenseForm.date || !expenseForm.category || !expenseForm.subcategory || !expenseForm.amount) return;
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);

    const expenseAmount = parseFloat(expenseForm.amount);
    
    // Update data in a transaction
    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }

      const newBudgets = { ...financeDoc.data().budgets };
      const category = expenseForm.category;
      const subcategory = expenseForm.subcategory;
      
      if (newBudgets[category] && newBudgets[category][subcategory] !== undefined) {
        newBudgets[category][subcategory] += expenseAmount;
      }
      
      const currentExpenses = financeDoc.data().expenses || [];
      const updatedExpenses = [...currentExpenses, {
        ...expenseForm,
        amount: expenseAmount
      }];

      transaction.update(financeDocRef, { budgets: newBudgets, expenses: updatedExpenses });
    });

    setExpenseForm({ date: '', category: '', subcategory: '', amount: '' });
  };

  const handleAddCategory = async () => {
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);

    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }

      const budgets = financeDoc.data().budgets || {};
      const categoryName = newCategory.name;
      const subcategories = newCategory.subcategories.reduce((acc, sub) => ({
        ...acc,
        [sub.name]: parseFloat(sub.budget)
      }), {});

      budgets[categoryName] = subcategories;

      transaction.update(financeDocRef, { budgets });
    });

    setNewCategory({ name: '', subcategories: [{ name: '', budget: '' }] });
    setShowCategoryModal(false);
  };
  
  const handleModifyCategory = async () => {
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);
    const { selectedCategory, newName } = categoryManagement;
  
    if (!selectedCategory || !newName) return;
  
    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }
  
      const budgets = { ...financeDoc.data().budgets };
      if (budgets[selectedCategory]) {
        const subcategories = budgets[selectedCategory];
        delete budgets[selectedCategory];
        budgets[newName] = subcategories;
        transaction.update(financeDocRef, { budgets });
      }
    });
  
    setShowCategoryModal(false);
  };
  
  const handleDeleteCategory = async () => {
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);
    const { selectedCategory } = categoryManagement;
  
    if (!selectedCategory) return;
  
    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }
  
      const budgets = { ...financeDoc.data().budgets };
      if (budgets[selectedCategory]) {
        delete budgets[selectedCategory];
        transaction.update(financeDocRef, { budgets });
      }
    });
  
    setShowCategoryModal(false);
  };
  
  const handleModifySubcategory = async () => {
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);
    const { selectedCategory, selectedSubcategory, newName } = categoryManagement;
  
    if (!selectedCategory || !selectedSubcategory || !newName) return;
  
    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }
  
      const budgets = { ...financeDoc.data().budgets };
      if (budgets[selectedCategory] && budgets[selectedCategory][selectedSubcategory] !== undefined) {
        const subcategories = { ...budgets[selectedCategory] };
        const budget = subcategories[selectedSubcategory];
        delete subcategories[selectedSubcategory];
        subcategories[newName] = budget;
        budgets[selectedCategory] = subcategories;
        transaction.update(financeDocRef, { budgets });
      }
    });
  
    setShowCategoryModal(false);
  };
  
  const handleDeleteSubcategory = async () => {
    const userId = auth.currentUser?.uid || 'anonymous';
    const dataPath = `/artifacts/${appId}/users/${userId}/data`;
    const financeDocRef = doc(db, dataPath, editor);
    const { selectedCategory, selectedSubcategory } = categoryManagement;
  
    if (!selectedCategory || !selectedSubcategory) return;
  
    await runTransaction(db, async (transaction) => {
      const financeDoc = await transaction.get(financeDocRef);
      if (!financeDoc.exists()) {
        throw "Document does not exist!";
      }
  
      const budgets = { ...financeDoc.data().budgets };
      if (budgets[selectedCategory] && budgets[selectedCategory][selectedSubcategory] !== undefined) {
        const subcategories = { ...budgets[selectedCategory] };
        delete subcategories[selectedSubcategory];
        budgets[selectedCategory] = subcategories;
        transaction.update(financeDocRef, { budgets });
      }
    });
  
    setShowCategoryModal(false);
  };
  

  // Render components based on state
  const renderView = () => {
    switch (view) {
      case 'summary':
        return (
          <div className="flex-1 p-6">
            <h2 className="text-3xl font-bold mb-6 text-center text-gray-800">Balance General</h2>
            <div className="flex items-center justify-center space-x-4 mb-8">
              <button
                onClick={() => handleDateChange('prev')}
                className="px-4 py-2 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-colors"
              >
                &lt;
              </button>
              <span className="text-xl font-semibold">
                {currentMonth}/{currentYear}
              </span>
              <button
                onClick={() => handleDateChange('next')}
                className="px-4 py-2 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-colors"
              >
                &gt;
              </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
              <div className="bg-green-100 p-6 rounded-2xl shadow-md border border-green-200">
                <h3 className="text-lg font-bold text-green-700">Ingresos del Mes</h3>
                <p className="text-2xl font-bold text-green-900 mt-2">${totalIncomes.toFixed(0)}</p>
              </div>
              <div className="bg-red-100 p-6 rounded-2xl shadow-md border border-red-200">
                <h3 className="text-lg font-bold text-red-700">Gastos del Mes</h3>
                <p className="text-2xl font-bold text-red-900 mt-2">${totalExpenses.toFixed(0)}</p>
              </div>
              <div className={`p-6 rounded-2xl shadow-md border ${monthlyBalance >= 0 ? 'bg-blue-100 border-blue-200' : 'bg-orange-100 border-orange-200'}`}>
                <h3 className="text-lg font-bold text-blue-700">Balance Mensual</h3>
                <p className={`text-2xl font-bold mt-2 ${monthlyBalance >= 0 ? 'text-blue-900' : 'text-orange-900'}`}>${monthlyBalance.toFixed(0)}</p>
              </div>
            </div>
          </div>
        );
      case 'records':
        return (
          <div className="flex-1 p-6">
            <h2 className="text-3xl font-bold mb-6 text-center text-gray-800">Registros</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <h3 className="text-2xl font-bold mb-4 text-gray-700">Registrar Ingreso</h3>
                <form onSubmit={handleIncomeSubmit} className="space-y-4">
                  <input
                    type="date"
                    value={incomeForm.date}
                    onChange={(e) => setIncomeForm({ ...incomeForm, date: e.target.value })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                    required
                  />
                  <input
                    type="text"
                    placeholder="Descripción"
                    value={incomeForm.description}
                    onChange={(e) => setIncomeForm({ ...incomeForm, description: e.target.value })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                    required
                  />
                  <input
                    type="number"
                    placeholder="Monto"
                    value={incomeForm.amount}
                    onChange={(e) => setIncomeForm({ ...incomeForm, amount: e.target.value })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                    required
                  />
                  <button
                    type="submit"
                    className="w-full p-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition-colors"
                  >
                    Guardar Ingreso
                  </button>
                </form>
              </div>
              <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <h3 className="text-2xl font-bold mb-4 text-gray-700">Registrar Gasto</h3>
                <form onSubmit={handleExpenseSubmit} className="space-y-4">
                  <input
                    type="date"
                    value={expenseForm.date}
                    onChange={(e) => setExpenseForm({ ...expenseForm, date: e.target.value })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                    required
                  />
                  <select
                    value={expenseForm.category}
                    onChange={(e) => setExpenseForm({ ...expenseForm, category: e.target.value, subcategory: '' })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">Selecciona una categoría</option>
                    {data.budgets && Object.keys(data.budgets).map(category => (
                      <option key={category} value={category}>{category}</option>
                    ))}
                  </select>
                  {expenseForm.category && data.budgets && data.budgets[expenseForm.category] && (
                    <select
                      value={expenseForm.subcategory}
                      onChange={(e) => setExpenseForm({ ...expenseForm, subcategory: e.target.value })}
                      className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                      required
                    >
                      <option value="">Selecciona una subcategoría</option>
                      {Object.keys(data.budgets[expenseForm.category]).map(sub => (
                        <option key={sub} value={sub}>{sub}</option>
                      ))}
                    </select>
                  )}
                  <input
                    type="number"
                    placeholder="Monto"
                    value={expenseForm.amount}
                    onChange={(e) => setExpenseForm({ ...expenseForm, amount: e.target.value })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                    required
                  />
                  <button
                    type="submit"
                    className="w-full p-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition-colors"
                  >
                    Guardar Gasto
                  </button>
                </form>
              </div>
            </div>
          </div>
        );
      case 'budgets':
        const budgetData = data.budgets || {};
        const getSpent = (category, subcategory) => {
          return filteredExpenses
            .filter(exp => exp.category === category && exp.subcategory === subcategory)
            .reduce((acc, exp) => acc + exp.amount, 0);
        };
        const getCategorySpent = (category) => {
          return filteredExpenses
            .filter(exp => exp.category === category)
            .reduce((acc, exp) => acc + exp.amount, 0);
        };
        const getCategoryBudget = (category) => {
          return Object.values(budgetData[category] || {}).reduce((acc, budget) => acc + budget, 0);
        };

        return (
          <div className="flex-1 p-6">
            <h2 className="text-3xl font-bold mb-6 text-center text-gray-800">Gestión de Presupuestos</h2>
            <div className="flex justify-center mb-6">
              <button
                onClick={() => setShowCategoryModal(true)}
                className="px-6 py-3 bg-purple-500 text-white font-bold rounded-full shadow-lg hover:bg-purple-600 transition-colors"
              >
                Gestionar Categorías
              </button>
            </div>
            <div className="space-y-6">
              {Object.keys(budgetData).map(category => (
                <div key={category} className="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                  <h3 className="text-2xl font-bold mb-4 text-gray-700">{category}</h3>
                  <div className="flex justify-between items-center text-sm font-semibold mb-2 text-gray-600">
                    <span>Presupuesto total: ${getCategoryBudget(category).toFixed(0)}</span>
                    <span>Gastado: ${getCategorySpent(category).toFixed(0)}</span>
                    <span>Restante: ${(getCategoryBudget(category) - getCategorySpent(category)).toFixed(0)}</span>
                  </div>
                  <div className="space-y-4">
                    {Object.keys(budgetData[category]).map(subcategory => {
                      const budget = budgetData[category][subcategory];
                      const spent = getSpent(category, subcategory);
                      const remaining = budget - spent;
                      return (
                        <div key={subcategory} className="bg-gray-50 p-4 rounded-xl shadow-sm border border-gray-100">
                          <div className="flex justify-between items-center mb-2">
                            <span className="font-semibold text-gray-800">{subcategory}</span>
                            <span className={`font-bold ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              ${remaining.toFixed(0)}
                            </span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div
                              className="h-2.5 rounded-full"
                              style={{
                                width: `${Math.min(100, (spent / budget) * 100)}%`,
                                backgroundColor: spent > budget ? 'rgb(239, 68, 68)' : 'rgb(59, 130, 246)'
                              }}
                            ></div>
                          </div>
                          <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Gastado: ${spent.toFixed(0)}</span>
                            <span>Presupuesto: ${budget.toFixed(0)}</span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      default:
        return null;
    }
  };

  if (showEditorModal) {
    return (
      <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
          <h2 className="text-2xl font-bold mb-6 text-gray-800">Seleccionar Editor</h2>
          <div className="space-y-4">
            <button
              onClick={() => { setEditor('BR'); setShowEditorModal(false); }}
              className="w-full py-3 bg-blue-500 text-white font-bold rounded-xl shadow-lg hover:bg-blue-600 transition-colors"
            >
              Editor BR
            </button>
            <button
              onClick={() => { setEditor('DT'); setShowEditorModal(false); }}
              className="w-full py-3 bg-blue-500 text-white font-bold rounded-xl shadow-lg hover:bg-blue-600 transition-colors"
            >
              Editor DT
            </button>
          </div>
          <p className="mt-6 text-sm text-gray-500">
            **ID de Usuario: {auth.currentUser?.uid || 'anonymous'}**
          </p>
        </div>
      </div>
    );
  }

  if (loading) {
    return <div className="flex justify-center items-center h-screen bg-gray-100"><div className="text-xl font-semibold text-gray-600">Cargando datos...</div></div>;
  }
  
  const renderCategoryModal = () => {
    return (
      <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-20">
        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl overflow-y-auto max-h-[90vh]">
          <h2 className="text-2xl font-bold mb-6 text-gray-800">Gestionar Categorías y Subcategorías</h2>
          
          <div className="space-y-6">
            <div className="bg-gray-50 p-6 rounded-xl shadow-inner">
              <h3 className="text-xl font-bold mb-4 text-gray-700">Agregar Nueva Categoría</h3>
              <form onSubmit={(e) => { e.preventDefault(); handleAddCategory(); }} className="space-y-4">
                <input
                  type="text"
                  placeholder="Nombre de la Categoría"
                  value={newCategory.name}
                  onChange={(e) => setNewCategory({ ...newCategory, name: e.target.value })}
                  className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                  required
                />
                {newCategory.subcategories.map((sub, index) => (
                  <div key={index} className="flex space-x-2 items-center">
                    <input
                      type="text"
                      placeholder="Nombre de la Subcategoría"
                      value={sub.name}
                      onChange={(e) => {
                        const newSubs = [...newCategory.subcategories];
                        newSubs[index].name = e.target.value;
                        setNewCategory({ ...newCategory, subcategories: newSubs });
                      }}
                      className="flex-1 p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                      required
                    />
                    <input
                      type="number"
                      placeholder="Presupuesto"
                      value={sub.budget}
                      onChange={(e) => {
                        const newSubs = [...newCategory.subcategories];
                        newSubs[index].budget = e.target.value;
                        setNewCategory({ ...newCategory, subcategories: newSubs });
                      }}
                      className="w-24 p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => {
                        const newSubs = [...newCategory.subcategories];
                        if (newSubs.length > 1) {
                          newSubs.splice(index, 1);
                          setNewCategory({ ...newCategory, subcategories: newSubs });
                        }
                      }}
                      className="text-red-500 hover:text-red-700 disabled:opacity-50"
                      disabled={newCategory.subcategories.length <= 1}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                ))}
                <button
                  type="button"
                  onClick={() => setNewCategory({ ...newCategory, subcategories: [...newCategory.subcategories, { name: '', budget: '' }] })}
                  className="w-full py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors"
                >
                  Agregar Subcategoría
                </button>
                <button type="submit" className="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition-colors">
                  Guardar Categoría
                </button>
              </form>
            </div>

            <div className="bg-gray-50 p-6 rounded-xl shadow-inner">
              <h3 className="text-xl font-bold mb-4 text-gray-700">Modificar/Eliminar Categoría</h3>
              <select
                value={categoryManagement.selectedCategory}
                onChange={(e) => setCategoryManagement({ ...categoryManagement, selectedCategory: e.target.value, selectedSubcategory: '', newName: '' })}
                className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4"
              >
                <option value="">Selecciona una categoría</option>
                {data.budgets && Object.keys(data.budgets).map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
              {categoryManagement.selectedCategory && (
                <>
                  <input
                    type="text"
                    placeholder="Nuevo nombre"
                    value={categoryManagement.newName}
                    onChange={(e) => setCategoryManagement({ ...categoryManagement, newName: e.target.value })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4"
                  />
                  <div className="flex space-x-2">
                    <button
                      onClick={handleModifyCategory}
                      className="flex-1 py-3 bg-blue-500 text-white font-bold rounded-xl shadow-lg hover:bg-blue-600 transition-colors"
                    >
                      Modificar
                    </button>
                    <button
                      onClick={handleDeleteCategory}
                      className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition-colors"
                    >
                      Eliminar
                    </button>
                  </div>
                </>
              )}
            </div>

            <div className="bg-gray-50 p-6 rounded-xl shadow-inner">
              <h3 className="text-xl font-bold mb-4 text-gray-700">Modificar/Eliminar Subcategoría</h3>
              <select
                value={categoryManagement.selectedCategory}
                onChange={(e) => setCategoryManagement({ ...categoryManagement, selectedCategory: e.target.value, selectedSubcategory: '', newName: '' })}
                className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4"
              >
                <option value="">Selecciona una categoría</option>
                {data.budgets && Object.keys(data.budgets).map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
              {categoryManagement.selectedCategory && (
                <>
                  <select
                    value={categoryManagement.selectedSubcategory}
                    onChange={(e) => setCategoryManagement({ ...categoryManagement, selectedSubcategory: e.target.value, newName: '' })}
                    className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4"
                  >
                    <option value="">Selecciona una subcategoría</option>
                    {data.budgets && Object.keys(data.budgets[categoryManagement.selectedCategory] || {}).map(sub => (
                      <option key={sub} value={sub}>{sub}</option>
                    ))}
                  </select>
                  {categoryManagement.selectedSubcategory && (
                    <>
                      <input
                        type="text"
                        placeholder="Nuevo nombre"
                        value={categoryManagement.newName}
                        onChange={(e) => setCategoryManagement({ ...categoryManagement, newName: e.target.value })}
                        className="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4"
                      />
                      <div className="flex space-x-2">
                        <button
                          onClick={handleModifySubcategory}
                          className="flex-1 py-3 bg-blue-500 text-white font-bold rounded-xl shadow-lg hover:bg-blue-600 transition-colors"
                        >
                          Modificar
                        </button>
                        <button
                          onClick={handleDeleteSubcategory}
                          className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition-colors"
                        >
                          Eliminar
                        </button>
                      </div>
                    </>
                  )}
                </>
              )}
            </div>
          </div>
          
          <div className="mt-8 flex justify-center">
            <button
              onClick={() => setShowCategoryModal(false)}
              className="px-6 py-3 bg-gray-400 text-white font-bold rounded-full shadow-lg hover:bg-gray-500 transition-colors"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    );
  };
  
  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-900 flex flex-col">
      <header className="bg-white shadow-md p-4 flex justify-between items-center fixed top-0 left-0 w-full z-10">
        <h1 className="text-xl sm:text-2xl font-bold text-blue-600">Finanzas Familiares</h1>
        <div className="hidden sm:flex space-x-2 sm:space-x-4">
          <button
            onClick={() => setView('summary')}
            className={`px-4 py-2 rounded-full font-semibold transition-colors ${view === 'summary' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
          >
            Balance
          </button>
          <button
            onClick={() => setView('records')}
            className={`px-4 py-2 rounded-full font-semibold transition-colors ${view === 'records' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
          >
            Registros
          </button>
          <button
            onClick={() => setView('budgets')}
            className={`px-4 py-2 rounded-full font-semibold transition-colors ${view === 'budgets' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
          >
            Presupuestos
          </button>
        </div>
      </header>

      <main className="flex-1 mt-[72px] pb-4">
        {renderView()}
      </main>

      <div className="fixed bottom-0 left-0 w-full bg-white shadow-md flex justify-around p-2 sm:hidden">
        <button
          onClick={() => setView('summary')}
          className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-colors ${view === 'summary' ? 'text-blue-600' : 'text-gray-500'}`}
        >
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-2.485 0-4.5 2.015-4.5 4.5S9.515 17 12 17s4.5-2.015 4.5-4.5S14.485 8 12 8z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v.01M12 18v.01M6.01 12H6M18.01 12h-.01" />
          </svg>
          <span className="text-xs">Balance</span>
        </button>
        <button
          onClick={() => setView('records')}
          className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-colors ${view === 'records' ? 'text-blue-600' : 'text-gray-500'}`}
        >
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-2-4v4m-2 4h4m-2 4v4" />
          </svg>
          <span className="text-xs">Registros</span>
        </button>
        <button
          onClick={() => setView('budgets')}
          className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-colors ${view === 'budgets' ? 'text-blue-600' : 'text-gray-500'}`}
        >
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9.5a2.5 2.5 0 01-5 0V7a1 1 0 00-1-1H9a1 1 0 00-1 1v2.5a2.5 2.5 0 01-5 0V7a1 1 0 00-1-1H3a1 1 0 00-1 1v2.5a2.5 2.5 0 01-5 0V7a1 1 0 00-1-1H.5M17 9a2.5 2.5 0 00-5 0V7a1 1 0 00-1-1H9a1 1 0 00-1 1v2a2.5 2.5 0 00-5 0V7a1 1 0 00-1-1H3a1 1 0 00-1 1v2a2.5 2.5 0 00-5 0V7a1 1 0 00-1-1H.5" />
          </svg>
          <span className="text-xs">Presupuestos</span>
        </button>
      </div>

      {showCategoryModal && renderCategoryModal()}
    </div>
  );
};

export default App;
