<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Finanzas Personales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334e68;
        }
        .container {
            max-width: 1000px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .btn {
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #4c51bf;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3e4491;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .input-field {
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #4c51bf;
            box-shadow: 0 0 0 2px rgba(76, 81, 191, 0.2);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            color: #718096;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #4c51bf;
        }
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #334e68;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="container mx-auto p-4 md:p-8 card">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-800">Finanzas Personales</h1>

        <!-- Pestañas de Navegación -->
        <div class="flex justify-center mb-6 overflow-x-auto">
            <button id="tab-registros" class="tab-button active">Registros</button>
            <button id="tab-presupuesto" class="tab-button">Presupuesto</button>
            <button id="tab-categorias" class="tab-button">Categorías</button>
        </div>

        <!-- Contenedor de Vistas -->
        <div id="view-container">

            <!-- Vista de Registros (predeterminada) -->
            <div id="view-registros" class="space-y-6">
                <!-- Secciones de Balance -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center text-sm font-semibold mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <p class="text-blue-700">Ingresos (mes)</p>
                        <p id="totalIngresos" class="text-blue-900 text-xl font-bold mt-1">Cargando...</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg">
                        <p class="text-red-700">Gastos (mes)</p>
                        <p id="totalGastos" class="text-red-900 text-xl font-bold mt-1">Cargando...</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <p class="text-green-700">Saldo Actual</p>
                        <p id="saldoTotal" class="text-green-900 text-xl font-bold mt-1">Cargando...</p>
                    </div>
                </div>

                <!-- Controles de Fecha y Descarga -->
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <select id="selectMonth" class="input-field w-1/2 sm:w-auto">
                            <option value="all">Todo el tiempo</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <select id="selectYear" class="input-field w-1/2 sm:w-auto"></select>
                    </div>
                    <div class="relative group">
                        <button id="downloadBtn" class="btn btn-secondary w-full sm:w-auto">
                            Descargar Excel
                            <div id="download-options" class="absolute hidden bg-white shadow-lg rounded-lg mt-2 w-48 right-0 z-10">
                                <button id="downloadVisibleBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-t-lg">Mes y Año Visibles</button>
                                <button id="downloadYearBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100">Por Año</button>
                                <button id="downloadAllBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-b-lg">Todos los Registros</button>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Formulario de Registro -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Nuevo Registro</h2>
                    <form id="recordForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo de Registro</label>
                            <select id="recordType" class="input-field mt-1">
                                <option value="ingreso">Ingreso</option>
                                <option value="gasto">Gasto</option>
                            </select>
                        </div>
                        <div id="ingreso-description-field" class="hidden">
                            <label for="ingresoDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                            <input type="text" id="ingresoDescription" placeholder="Ej: Venta de algo" class="input-field mt-1">
                        </div>
                        <div id="gasto-fields" class="space-y-4">
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
                                <select id="category" class="input-field mt-1">
                                    <option value="">Seleccione una categoría</option>
                                </select>
                            </div>
                            <div>
                                <label for="subcategory" class="block text-sm font-medium text-gray-700">Subcategoría</label>
                                <select id="subcategory" class="input-field mt-1">
                                    <option value="">Seleccione una subcategoría</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Monto</label>
                            <input type="number" id="amount" placeholder="10000" class="input-field mt-1" required>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary w-full sm:w-auto">Agregar Registro</button>
                        </div>
                    </form>
                </div>

                <!-- Historial de Registros -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Historial de Registros</h2>
                    <div id="recordsList" class="space-y-4">
                        <p class="text-center text-gray-500">No hay registros para este período.</p>
                    </div>
                </div>
            </div>

            <!-- Vista de Presupuesto (oculta por defecto) -->
            <div id="view-presupuesto" class="hidden">
                <div class="card p-6 space-y-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Presupuesto Mensual y Anual</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center text-sm font-semibold mb-6">
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <p class="text-purple-700">Presupuesto Mensual</p>
                            <p id="presupuestoMensual" class="text-purple-900 text-xl font-bold mt-1">Cargando...</p>
                        </div>
                        <div class="bg-indigo-100 p-4 rounded-lg">
                            <p class="text-indigo-700">Presupuesto Anual</p>
                            <p id="presupuestoAnual" class="text-indigo-900 text-xl font-bold mt-1">Cargando...</p>
                        </div>
                    </div>
                    <div id="budgetSubcategories" class="space-y-4">
                        <p class="text-center text-gray-500">Selecciona un mes y año para gestionar tu presupuesto.</p>
                    </div>
                </div>
            </div>
            
            <!-- Vista de Categorías (oculta por defecto) -->
            <div id="view-categorias" class="hidden">
                <div class="card p-6 space-y-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800" id="formTitle">Agregar Nueva Categoría</h2>
                    <form id="categoryForm" class="space-y-4">
                        <div>
                            <label for="categoryName" class="block text-sm font-medium text-gray-700">Nombre de Categoría</label>
                            <input type="text" id="categoryName" name="categoryName" placeholder="Ej: Alimentación" required class="input-field mt-1">
                        </div>
                        <div>
                            <label for="subcategories" class="block text-sm font-medium text-gray-700">Subcategorías (separadas por coma)</label>
                            <input type="text" id="subcategories" name="subcategories" placeholder="Ej: Supermercado, Feria" required class="input-field mt-1">
                        </div>
                        <input type="hidden" id="categoryId">
                        <button type="submit" class="btn btn-primary w-full">Guardar Categoría</button>
                    </form>
                    <div id="categoryList" class="space-y-4">
                        <p class="text-center text-gray-500">No hay categorías añadidas aún.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="deleteModal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="modal-content p-6 card max-w-sm mx-auto">
            <h3 class="text-lg font-bold mb-4">Confirmar Eliminación</h3>
            <p class="text-gray-700 mb-6">¿Estás seguro de que deseas eliminar la categoría <span id="modalCategoryName" class="font-semibold"></span>?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancelar</button>
                <button id="confirmDeleteBtn" class="btn bg-red-500 text-white hover:bg-red-600">Eliminar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        setLogLevel('debug');

        // Global Firebase variables provided by the environment
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        let db;
        let auth;
        let userId;

        // UI elements
        const tabs = {
            'tab-registros': document.getElementById('view-registros'),
            'tab-presupuesto': document.getElementById('view-presupuesto'),
            'tab-categorias': document.getElementById('view-categorias')
        };
        const recordForm = document.getElementById('recordForm');
        const recordTypeSelect = document.getElementById('recordType');
        const ingresoDescriptionField = document.getElementById('ingreso-description-field');
        const gastoFields = document.getElementById('gasto-fields');
        const amountInput = document.getElementById('amount');
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const recordsList = document.getElementById('recordsList');
        const totalIngresosEl = document.getElementById('totalIngresos');
        const totalGastosEl = document.getElementById('totalGastos');
        const saldoTotalEl = document.getElementById('saldoTotal');
        const selectMonth = document.getElementById('selectMonth');
        const selectYear = document.getElementById('selectYear');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadOptions = document.getElementById('download-options');
        const downloadVisibleBtn = document.getElementById('downloadVisibleBtn');
        const downloadYearBtn = document.getElementById('downloadYearBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const presupuestoMensualEl = document.getElementById('presupuestoMensual');
        const presupuestoAnualEl = document.getElementById('presupuestoAnual');
        const budgetSubcategoriesDiv = document.getElementById('budgetSubcategories');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const subcategoriesInput = document.getElementById('subcategories');
        const categoryIdInput = document.getElementById('categoryId');
        const categoryListDiv = document.getElementById('categoryList');
        const formTitle = document.getElementById('formTitle');
        const deleteModal = document.getElementById('deleteModal');
        const modalCategoryName = document.getElementById('modalCategoryName');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        // Hardcoded categories and subcategories from the provided document
        const hardcodedCategories = [
            {
                name: "Fijos del hogar",
                subcategories: ["Dividendo", "Luz", "Agua", "Gas", "Basura", "Wifi", "Streaming", "Mantención Aire", "Plan móvil"]
            },
            {
                name: "Alimentación",
                subcategories: ["Supermercado", "Feria"]
            },
            {
                name: "Educación",
                subcategories: ["Matrícula", "Arancel"]
            },
            {
                name: "Salud",
                subcategories: ["Seguro"]
            },
            {
                name: "Transporte",
                subcategories: ["BIP", "Combustible", "Permiso circulación", "Mantención", "TAG"]
            },
            {
                name: "Gin",
                subcategories: ["Comida", "Salud"]
            },
            {
                name: "Eventos",
                subcategories: ["Navidad", "Vacaciones", "Cumple hija", "Cumple BR", "Cumple DT", "Cumpleaños"]
            },
            {
                name: "Presupuestos individuales",
                subcategories: ["Presupuesto BR", "Presupuesto Hija", "Presupuesto DT"]
            }
        ];

        let allCategories = [];
        let recordsUnsubscribe = null;
        let budgetUnsubscribe = null;
        let categoryUnsubscribe = null;
        let categoryToDeleteId = null;
        let allRecords = [];

        // Utility function to format numbers as Chilean Pesos
        function formatCLP(number) {
            if (typeof number !== 'number' || isNaN(number)) {
                return '$0';
            }
            return `$${Math.round(number).toLocaleString('es-CL')}`;
        }

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialized.");

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated. UID:", userId);
                        setupListeners();
                        populateYearDropdown();
                        loadCategories();
                    } else {
                        console.log("User not authenticated.");
                        userId = null;
                        recordsList.innerHTML = `<p class="text-center text-gray-500">Por favor, inicie sesión para ver sus registros.</p>`;
                        totalIngresosEl.textContent = 'N/A';
                        totalGastosEl.textContent = 'N/A';
                        saldoTotalEl.textContent = 'N/A';
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // Set up all Firestore listeners
        function setupListeners() {
            if (recordsUnsubscribe) recordsUnsubscribe();
            if (budgetUnsubscribe) budgetUnsubscribe();

            const recordsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'records');
            recordsUnsubscribe = onSnapshot(recordsCollectionRef, (snapshot) => {
                allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
            }, (error) => {
                console.error("Error fetching records:", error);
            });
            
            const budgetsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'budgets');
            budgetUnsubscribe = onSnapshot(budgetsCollectionRef, (snapshot) => {
                updateView();
            }, (error) => {
                console.error("Error fetching budgets:", error);
            });
        }

        // Populate year dropdown
        function populateYearDropdown() {
            const currentYear = new Date().getFullYear();
            const startYear = 2024;
            const endYear = 2060;
            selectYear.innerHTML = '';
            
            const allYearsOption = document.createElement('option');
            allYearsOption.value = 'all';
            allYearsOption.textContent = 'Todo el tiempo';
            selectYear.appendChild(allYearsOption);

            for (let year = currentYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                selectYear.appendChild(option);
            }
            selectYear.value = currentYear;
        }

        // Event listener for tab clicks
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                // Remove active class from all buttons and hide all views
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                Object.values(tabs).forEach(view => view.classList.add('hidden'));

                // Add active class to the clicked button and show the corresponding view
                e.target.classList.add('active');
                const viewId = e.target.id.replace('tab-', 'view-');
                tabs[e.target.id].classList.remove('hidden');

                if (viewId === 'view-registros') {
                    updateView();
                } else if (viewId === 'view-presupuesto') {
                    renderBudgetView();
                } else if (viewId === 'view-categorias') {
                    renderCategoriesView();
                }
            });
        });

        // Event listener for record form submission
        recordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = recordTypeSelect.value;
            const amount = parseFloat(amountInput.value);
            const date = new Date().toISOString().split('T')[0];
            
            if (isNaN(amount) || amount <= 0) {
                // No se usa alert() para evitar problemas con el iframe
                console.error("Por favor, ingrese un monto válido.");
                return;
            }

            let newRecord;
            let categoryName = '';
            let subcategoryName = '';

            if (type === 'ingreso') {
                const description = document.getElementById('ingresoDescription').value.trim() || 'Ingreso sin descripción';
                newRecord = {
                    type: 'ingreso',
                    amount: amount,
                    description: description,
                    date: date,
                    timestamp: Date.now(),
                    editor: userId,
                };
            } else { // 'gasto'
                categoryName = categorySelect.value;
                subcategoryName = subcategorySelect.value;
                if (!categoryName || !subcategoryName) {
                    // No se usa alert()
                    console.error("Por favor, seleccione una categoría y subcategoría.");
                    return;
                }
                newRecord = {
                    type: 'gasto',
                    amount: amount,
                    category: categoryName,
                    subcategory: subcategoryName,
                    date: date,
                    timestamp: Date.now(),
                    editor: userId,
                };
                // Automatically set budget for this subcategory if it's the first record
                await setBudget(subcategoryName, amount);
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'records'), newRecord);
                recordForm.reset();
                console.log("Registro agregado con éxito.");
            } catch (error) {
                console.error("Error al agregar registro:", error);
                // No se usa alert()
            }
        });

        // Event listener for record type change
        recordTypeSelect.addEventListener('change', () => {
            const type = recordTypeSelect.value;
            if (type === 'ingreso') {
                ingresoDescriptionField.classList.remove('hidden');
                gastoFields.classList.add('hidden');
                amountInput.placeholder = "10000";
            } else { // 'gasto'
                ingresoDescriptionField.classList.add('hidden');
                gastoFields.classList.remove('hidden');
                amountInput.placeholder = "10000";
            }
        });

        // Event listener for category change
        categorySelect.addEventListener('change', (e) => {
            const selectedCategoryName = e.target.value;
            const selectedCategory = hardcodedCategories.find(c => c.name === selectedCategoryName) || allCategories.find(c => c.name === selectedCategoryName);
            
            subcategorySelect.innerHTML = '<option value="">Seleccione una subcategoría</option>';
            if (selectedCategory) {
                selectedCategory.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        });

        // Filtering and Rendering Records
        selectMonth.addEventListener('change', updateView);
        selectYear.addEventListener('change', updateView);

        function updateView() {
            const selectedMonth = selectMonth.value;
            const selectedYear = selectYear.value;

            const filteredRecords = allRecords.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = recordDate.getMonth() + 1;
                const recordYear = recordDate.getFullYear();
                
                const isMonthMatch = selectedMonth === 'all' || recordMonth === parseInt(selectedMonth);
                const isYearMatch = selectedYear === 'all' || recordYear === parseInt(selectedYear);
                
                return isMonthMatch && isYearMatch;
            });

            // Update balances and render records
            renderBalances(filteredRecords);
            renderRecords(filteredRecords);
            renderBudgetView();
        }

        // Render Balances
        function renderBalances(records) {
            const totalIngresos = records.filter(r => r.type === 'ingreso').reduce((sum, r) => sum + r.amount, 0);
            const totalGastos = records.filter(r => r.type === 'gasto').reduce((sum, r) => sum + r.amount, 0);
            
            totalIngresosEl.textContent = formatCLP(totalIngresos);
            totalGastosEl.textContent = formatCLP(totalGastos);
            
            const saldoGlobal = allRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getFullYear() <= new Date().getFullYear() && recordDate.getMonth() <= new Date().getMonth();
            }).reduce((sum, r) => {
                return r.type === 'ingreso' ? sum + r.amount : sum - r.amount;
            }, 0);

            saldoTotalEl.textContent = formatCLP(saldoGlobal);
        }

        // Render Records
        function renderRecords(records) {
            recordsList.innerHTML = '';
            if (records.length === 0) {
                recordsList.innerHTML = `<p class="text-center text-gray-500">No hay registros para este período.</p>`;
                return;
            }

            const sortedRecords = records.sort((a, b) => b.timestamp - a.timestamp);

            sortedRecords.forEach(record => {
                const recordEl = document.createElement('div');
                const isGasto = record.type === 'gasto';
                
                let title = '';
                if (isGasto) {
                    title = `${record.category} - ${record.subcategory}`;
                } else {
                    title = record.description;
                }
                
                const formattedDate = new Date(record.date).toLocaleDateString('es-CL', {
                    day: '2-digit', month: 'short', year: 'numeric'
                });

                recordEl.className = `p-4 rounded-lg flex items-center justify-between shadow-sm border ${isGasto ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'}`;
                recordEl.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-bold truncate">${isGasto ? 'Gasto: ' : 'Ingreso: '} ${title}</p>
                        <p class="text-sm text-gray-500 mt-1">${formattedDate}</p>
                    </div>
                    <div class="flex items-center space-x-3 ml-4">
                        <span class="font-bold ${isGasto ? 'text-red-600' : 'text-blue-600'} flex-shrink-0">${formatCLP(record.amount)}</span>
                        <button class="delete-record-btn text-gray-400 hover:text-red-500" data-id="${record.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                recordsList.appendChild(recordEl);
            });
            document.querySelectorAll('.delete-record-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const recordId = e.currentTarget.dataset.id;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'records', recordId));
                        console.log("Registro eliminado con éxito.");
                    } catch (error) {
                        console.error("Error al eliminar el registro:", error);
                    }
                });
            });
        }

        // Download functionality
        downloadBtn.addEventListener('click', () => {
            downloadOptions.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!downloadBtn.contains(e.target) && !downloadOptions.contains(e.target)) {
                downloadOptions.classList.add('hidden');
            }
        });
        downloadVisibleBtn.addEventListener('click', () => downloadExcel(false, false));
        downloadYearBtn.addEventListener('click', () => downloadExcel(true, false));
        downloadAllBtn.addEventListener('click', () => downloadExcel(false, true));

        async function downloadExcel(isYearly, isAll) {
            const recordsToDownload = await getRecordsToDownload(isYearly, isAll);
            const data = recordsToDownload.map(record => ({
                Tipo: record.type === 'ingreso' ? 'Ingreso' : 'Gasto',
                Monto: record.amount,
                Descripción: record.type === 'ingreso' ? record.description : '',
                Categoría: record.type === 'gasto' ? record.category : '',
                Subcategoría: record.type === 'gasto' ? record.subcategory : '',
                Fecha: record.date,
                Editor: record.editor
            }));
            
            if (data.length === 0) {
                // No se usa alert()
                console.warn("No hay registros para descargar.");
                return;
            }

            const sheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, sheet, "Registros");
            XLSX.writeFile(workbook, "registros_financieros.xlsx");
            downloadOptions.classList.add('hidden');
        }

        async function getRecordsToDownload(isYearly, isAll) {
            const recordsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'records');
            let q = query(recordsCollectionRef);
            let records = [];

            if (isAll) {
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() });
                });
            } else if (isYearly) {
                const year = selectYear.value;
                if (year === 'all') {
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                } else {
                    const yearRecords = allRecords.filter(record => new Date(record.date).getFullYear() === parseInt(year));
                    records = yearRecords;
                }
            } else {
                const month = selectMonth.value;
                const year = selectYear.value;
                if (month === 'all' && year === 'all') {
                    records = allRecords;
                } else {
                    records = allRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        const recordMonth = recordDate.getMonth() + 1;
                        const recordYear = recordDate.getFullYear();
                        return (month === 'all' || recordMonth === parseInt(month)) &&
                               (year === 'all' || recordYear === parseInt(year));
                    });
                }
            }
            return records;
        }

        // Budget View
        async function renderBudgetView() {
            const selectedYear = selectYear.value;
            const selectedMonth = selectMonth.value;

            if (selectedMonth === 'all' || selectedYear === 'all') {
                budgetSubcategoriesDiv.innerHTML = `<p class="text-center text-gray-500">Seleccione un mes y año específico para ver el presupuesto.</p>`;
                presupuestoMensualEl.textContent = 'N/A';
                presupuestoAnualEl.textContent = 'N/A';
                return;
            }

            const monthKey = `${selectedYear}-${selectedMonth}`;
            const budgetsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'budgets');
            const q = query(budgetsCollectionRef, where('monthKey', '==', monthKey));
            const querySnapshot = await getDocs(q);
            const monthlyBudgets = {};
            querySnapshot.forEach(doc => {
                monthlyBudgets[doc.data().subcategory] = { id: doc.id, amount: doc.data().amount };
            });

            // Calculate monthly and annual budgets
            const recordsInMonth = allRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getFullYear() === parseInt(selectedYear) && (recordDate.getMonth() + 1) === parseInt(selectedMonth);
            });
            const recordsInYear = allRecords.filter(r => new Date(r.date).getFullYear() === parseInt(selectedYear));
            
            const uniqueSubcategoriesInYear = [...new Set(recordsInYear.filter(r => r.type === 'gasto').map(r => r.subcategory))];
            
            let totalMonthlyBudget = 0;
            let totalAnnualBudget = 0;

            const budgetPromises = uniqueSubcategoriesInYear.map(async subcategoryName => {
                const qSubcategoryBudget = query(budgetsCollectionRef, where('subcategory', '==', subcategoryName), where('year', '==', parseInt(selectedYear)));
                const subcategoryBudgetSnapshot = await getDocs(qSubcategoryBudget);
                let subcategoryAnnualBudget = 0;
                subcategoryBudgetSnapshot.forEach(doc => {
                    subcategoryAnnualBudget += doc.data().amount;
                });
                totalAnnualBudget += subcategoryAnnualBudget;
            });
            await Promise.all(budgetPromises);

            const monthlyBudgetPromises = Object.keys(monthlyBudgets).map(async subcategoryName => {
                totalMonthlyBudget += monthlyBudgets[subcategoryName].amount;
            });
            await Promise.all(monthlyBudgetPromises);

            presupuestoMensualEl.textContent = formatCLP(totalMonthlyBudget);
            presupuestoAnualEl.textContent = formatCLP(totalAnnualBudget);

            budgetSubcategoriesDiv.innerHTML = '';
            const allSubcategories = hardcodedCategories.flatMap(cat => cat.subcategories.map(sub => ({
                category: cat.name,
                subcategory: sub
            })));

            const budgetHeader = document.createElement('div');
            budgetHeader.className = "flex justify-between items-center font-bold text-gray-700 py-2 border-b-2 border-gray-200";
            budgetHeader.innerHTML = `
                <div class="flex-1">Subcategoría</div>
                <div class="flex-1 text-right">Presupuesto</div>
                <div class="flex-1 text-right mr-10">Gastos</div>
            `;
            budgetSubcategoriesDiv.appendChild(budgetHeader);

            allSubcategories.forEach(sub => {
                const monthlyExpenses = recordsInMonth
                    .filter(r => r.type === 'gasto' && r.subcategory === sub.subcategory)
                    .reduce((sum, r) => sum + r.amount, 0);

                const currentBudget = monthlyBudgets[sub.subcategory]?.amount || 0;

                const budgetItem = document.createElement('div');
                budgetItem.className = 'flex justify-between items-center py-4 border-b border-gray-200 last:border-b-0';
                budgetItem.innerHTML = `
                    <div class="flex-1 font-medium text-gray-800">${sub.category}: ${sub.subcategory}</div>
                    <div class="flex-1 flex items-center justify-end space-x-2">
                        <input type="number" value="${currentBudget}" data-subcategory="${sub.subcategory}" class="budget-input input-field w-24 text-right">
                    </div>
                    <div class="flex-1 text-right font-bold mr-10">${formatCLP(monthlyExpenses)}</div>
                `;
                budgetSubcategoriesDiv.appendChild(budgetItem);
            });
            
            document.querySelectorAll('.budget-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const subcategoryName = e.target.dataset.subcategory;
                    const newAmount = parseFloat(e.target.value) || 0;
                    setBudget(subcategoryName, newAmount);
                });
            });
        }

        // Budget creation and update
        async function setBudget(subcategory, amount) {
            const selectedYear = selectYear.value;
            const selectedMonth = selectMonth.value;

            if (selectedMonth === 'all' || selectedYear === 'all') {
                return;
            }

            const monthKey = `${selectedYear}-${selectedMonth}`;
            const budgetsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'budgets');
            const q = query(budgetsCollectionRef, where('monthKey', '==', monthKey), where('subcategory', '==', subcategory));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const docRef = querySnapshot.docs[0].ref;
                await updateDoc(docRef, { amount: amount });
            } else {
                await addDoc(budgetsCollectionRef, {
                    monthKey: monthKey,
                    year: parseInt(selectedYear),
                    subcategory: subcategory,
                    amount: amount
                });
            }
        }

        // Categorias View
        function renderCategoriesView() {
            if (!userId) {
                categoryListDiv.innerHTML = `<p class="text-center text-gray-500">Por favor, inicie sesión para gestionar sus categorías.</p>`;
                return;
            }
            if (categoryUnsubscribe) categoryUnsubscribe();
            
            const q = collection(db, 'artifacts', appId, 'users', userId, 'categories');
            categoryUnsubscribe = onSnapshot(q, (snapshot) => {
                const categories = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    categories.push({ id: doc.id, ...data });
                });
                allCategories = categories.sort((a,b) => a.name.localeCompare(b.name));
                populateCategoryDropdowns();
                renderCategoryList(allCategories);
            }, (error) => {
                console.error("Error al obtener las categorías en tiempo real:", error);
            });
        }

        function populateCategoryDropdowns() {
            categorySelect.innerHTML = '<option value="">Seleccione una categoría</option>';
            hardcodedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            // Trigger change to populate subcategories
            if (categorySelect.value) {
                categorySelect.dispatchEvent(new Event('change'));
            }
        }

        function renderCategoryList(categories) {
            categoryListDiv.innerHTML = '';
            if (categories.length === 0) {
                categoryListDiv.innerHTML = `<p class="text-center text-gray-500">No hay categorías añadidas aún.</p>`;
                return;
            }
            categories.forEach(category => {
                const subcategories = Array.isArray(category.subcategories) ? category.subcategories.join(', ') : '';
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item flex justify-between items-center py-4 border-b border-gray-200 last:border-b-0';
                categoryItem.innerHTML = `
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">${category.name}</h3>
                        <p class="text-sm text-gray-500">${subcategories}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-btn" data-id="${category.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button class="delete-btn" data-id="${category.id}" data-name="${category.name}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                categoryListDiv.appendChild(categoryItem);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', editCategory);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', showDeleteModal);
            });
        }

        // Category Form Handlers
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryId = categoryIdInput.value;
            const categoryName = categoryNameInput.value.trim();
            const subcategoriesStr = subcategoriesInput.value.trim();
            const subcategories = subcategoriesStr.split(',').map(s => s.trim()).filter(s => s.length > 0);

            if (!categoryName || subcategories.length === 0) {
                console.error("Nombre de categoría o subcategorías están vacíos.");
                return;
            }

            const categoryData = {
                name: categoryName,
                subcategories: subcategories,
                createdAt: new Date()
            };

            if (!userId) {
                console.error("ID de usuario no disponible.");
                return;
            }

            try {
                const categoriesCollection = collection(db, 'artifacts', appId, 'users', userId, 'categories');
                if (categoryId) {
                    await setDoc(doc(categoriesCollection, categoryId), categoryData, { merge: true });
                    console.log("Categoría editada con éxito.");
                } else {
                    await addDoc(categoriesCollection, categoryData);
                    console.log("Nueva categoría agregada con éxito.");
                }
                resetCategoryForm();
            } catch (error) {
                console.error("Error al guardar la categoría:", error);
            }
        });

        function editCategory(event) {
            const categoryId = event.currentTarget.dataset.id;
            const categoryItem = event.currentTarget.closest('.category-item');
            const categoryName = categoryItem.querySelector('h3').textContent;
            const subcategories = categoryItem.querySelector('p').textContent;

            categoryIdInput.value = categoryId;
            categoryNameInput.value = categoryName;
            subcategoriesInput.value = subcategories;
            formTitle.textContent = "Editar Categoría";
        }

        function showDeleteModal(event) {
            const categoryId = event.currentTarget.dataset.id;
            const categoryName = event.currentTarget.dataset.name;
            if (!categoryId || !categoryName) {
                console.error("ID o nombre de categoría no encontrados para el modal.");
                return;
            }
            categoryToDeleteId = categoryId;
            modalCategoryName.textContent = categoryName;
            deleteModal.classList.remove('hidden');
        }

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            categoryToDeleteId = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!categoryToDeleteId) {
                console.error("Error: ID de categoría para eliminar es nulo.");
                return;
            }
            try {
                if (!userId) {
                    console.error("Usuario no autenticado, no se puede eliminar la categoría.");
                    return;
                }
                
                const categoryRef = doc(db, 'artifacts', appId, 'users', userId, 'categories', categoryToDeleteId);
                await deleteDoc(categoryRef);
                console.log("Categoría eliminada con éxito.");
                deleteModal.classList.add('hidden');
                categoryToDeleteId = null;

            } catch (error) {
                console.error("Error al eliminar categoría:", error);
                deleteModal.classList.add('hidden');
                categoryToDeleteId = null;
            }
        });

        function resetCategoryForm() {
            categoryForm.reset();
            categoryIdInput.value = '';
            formTitle.textContent = "Agregar Nueva Categoría";
        }

        // Load Categories on app start
        async function loadCategories() {
            if (!userId) {
                console.error("No se pueden cargar las categorías, el usuario no está autenticado.");
                return;
            }
            const q = collection(db, 'artifacts', appId, 'users', userId, 'categories');
            const querySnapshot = await getDocs(q);
            const categories = [];
            querySnapshot.forEach(doc => {
                categories.push({ id: doc.id, ...doc.data() });
            });
            allCategories = categories.sort((a,b) => a.name.localeCompare(b.name));
            populateCategoryDropdowns();
        }

        // Initialize Excel library
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js';
        document.head.appendChild(script);

        // Initial setup
        initializeFirebase();
    </script>
</body>
</html>
